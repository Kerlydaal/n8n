"use strict";var mi=Object.create;var ze=Object.defineProperty;var fi=Object.getOwnPropertyDescriptor;var hi=Object.getOwnPropertyNames;var Ei=Object.getPrototypeOf,Ii=Object.prototype.hasOwnProperty;var f=(t,e)=>()=>(t&&(e=t(t=0)),e);var qt=(t,e)=>{for(var r in e)ze(t,r,{get:e[r],enumerable:!0})},on=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of hi(e))!Ii.call(t,s)&&s!==r&&ze(t,s,{get:()=>e[s],enumerable:!(n=fi(e,s))||n.enumerable});return t};var g=(t,e,r)=>(r=t!=null?mi(Ei(t)):{},on(e||!t||!t.__esModule?ze(r,"default",{value:t,enumerable:!0}):r,t)),Ci=t=>on(ze({},"__esModule",{value:!0}),t);var i=f(()=>{"use strict"});var fe,Kt=f(()=>{"use strict";i();fe=class extends Error{}});var Qe,Jt=f(()=>{"use strict";i();Qe={guide:{ciBuildId:"https://docs.currents.dev/guides/ci-build-id",integration:"https://docs.currents.dev/integration-with-playwright/currents-playwright"}}});function an(t){Ti.push(t)}var Ti,Yt=f(()=>{"use strict";i();Ti=[]});var Le,se,Xe=f(()=>{"use strict";i();Le=[],se=[]});var x,he,Fe,P,d,Ee,un,_,Ie,Ce,cn,ln,De,z,pn,Te,oe,Me,Be,uu,cu,ke,m,lu,gn=f(()=>{"use strict";i();x=g(require("chalk")),he=g(require("util"));E();Yt();Xe();Fe=(...t)=>{let e=he.default.format(...t);an(e),console.log(e)},P=Fe,d=(...t)=>{let e=he.default.format(...t);return se.push(e),l("WARNING: ",e),Fe(x.default.bgYellow.black(" WARNING "),e)},Ee=(...t)=>{let e=he.default.format(...t);return l("WARNING: ",e),Fe(x.default.bgYellow.black(" WARNING "),e)},un=(...t)=>{let e=he.default.format(...t);return l("ERRRO: ",e),Fe(x.default.bgRed.white(" ERROR "),e)},_=(...t)=>{let e=he.default.format(...t);return Le.push(e),l("ERROR: ",e),Fe(x.default.bgRed.white(" ERROR "),e)},Ie=()=>console.log(`
`+Ce()+`
`),Ce=()=>x.default.dim(Array(64).fill("=").join("")),cn=(t="",e=64)=>{let r=` start of ${t??"block"} `,n=Math.max(e-r.length,0)/2,s=Math.floor(n),o=Math.ceil(n);return x.default.dim(`${Array(s).fill("-").join("")}${r}${Array(o).fill("-").join("")}`)},ln=(t="",e=64)=>{let r=` end of ${t??"block"} `,n=Math.max(e-r.length,0)/2,s=Math.floor(n),o=Math.ceil(n);return x.default.dim(`${Array(s).fill("-").join("")}${r}${Array(o).fill("-").join("")}`)},De=(t=2)=>console.log(Array(t).fill("").join(`
`)),z=x.default.cyan,pn=x.default.blueBright,Te=x.default.red,oe=x.default.yellow,Me=x.default.green,Be=x.default.gray,uu=x.default.white,cu=x.default.black,ke=x.default.magenta,m=x.default.dim,lu=x.default.bold});var R=f(()=>{"use strict";i();Yt();gn()});function mn(t){if(!t)return;if(t==="false")return!1;let e=parseInt(t,10);if(isNaN(e)||e<1)throw new dn.CommanderError(255,"Invalid argument provided.","--pwc-cancel-after-failures must be a positive integer or 'false', provided: "+t);return e}var dn,fn=f(()=>{"use strict";i();dn=require("commander")});function hn(t){return F[t]?.env}function En(t){return F[t].cli}function In(t){return F[t].name}function Cn(){return{projectId:process.env[F.projectId.env],recordKey:process.env[F.recordKey.env],ciBuildId:process.env[F.ciBuildId.env],tag:process.env[F.tag.env]?process.env[F.tag.env]?.split(",").map(t=>t.trim()):void 0,cancelAfterFailures:mn(process.env[F.cancelAfterFailures.env]),disableTitleTags:process.env[F.disableTitleTags.env],testSuiteFile:process.env[F.testSuiteFile.env],machineId:process.env[F.machineId.env],orchestrationId:process.env[F.orchestrationId.env]}}var F,zt=f(()=>{"use strict";i();fn();F={currentsConfigFile:{name:"Currents Config File Path",env:"CURRENTS_CONFIG_FILE_PATH",cli:"--pwc-config"},ciBuildId:{name:"CI Build ID",env:"CURRENTS_CI_BUILD_ID",cli:"--ci-build-id"},recordKey:{name:"Record Key",env:"CURRENTS_RECORD_KEY",cli:"--key"},projectId:{name:"Project ID",env:"CURRENTS_PROJECT_ID",cli:"--project-id"},tag:{name:"Currents Tag",env:"CURRENTS_TAG",cli:"--tag"},cancelAfterFailures:{name:"Currents Cancel After Failures",env:"CURRENTS_CANCEL_AFTER_FAILURES",cli:"--pwc-cancel-after-failures"},disableTitleTags:{name:"Disable Title Tags",env:"CURRENTS_DISABLE_TITLE_TAGS",cli:"--pwc-disable-title-tags"},testSuiteFile:{name:"Test Suite File",env:"CURRENTS_TEST_SUITE_FILE",cli:"--pwc-test-suite-file"},machineId:{name:"Machine ID",env:"CURRENTS_MACHINE_ID",cli:"--pwc-machine-id"},orchestrationId:{name:"Orchestration ID",env:"CURRENTS_ORCHESTRATION_ID",cli:"--pwc-orchestration-id"},outputFile:{name:"Output File",env:"CURRENTS_OUTPUT_FILE",cli:"--pwc-output-file"},batchSize:{name:"Batch Size",env:"CURRENTS_BATCH_SIZE",cli:"--pwc-batch-size"}}});function ye(){if(Qt)return Qt;if(process.env.CURRENTS_PWC_CLI_CONFIG_PATH)try{let t=JSON.parse(Rn.default.readFileSync(process.env.CURRENTS_PWC_CLI_CONFIG_PATH).toString());return Tn("Options from serialized CLI config file: %o",t),Qt=t,t}catch(t){return Tn("Could not read CLI config file: %o",t),{}}return{}}var Rn,Tn,Qt,Xt=f(()=>{"use strict";i();Rn=g(require("fs"));E();Tn=l.extend("cli-options-serializer"),Qt=null});function yn(t,e,r={validationFn:tr}){Zt("reporter options: %o",t),Zt("config file options: %o",e);let n={...D(er),...D(e),...D(t),...D(ye()),...D(Cn()),orchestration:{...D(er.orchestration),...D(e?.orchestration),...D(t?.orchestration),...D(ye().orchestration)},coverage:{...D(er.coverage),...D(e?.coverage),...D(t?.coverage),...D(ye().coverage)}};r.validationFn(n),Ze=n,Zt("resolved currents config: %o",Ze)}function tr(t){Ri.forEach(e=>{if(!t[e])throw _(`${In(e)} is required for Currents Reporter. Use the following methods:
  - environment variable: ${m(hn(e))}
  - CLI flag: ${m(En(e))}
  - reporter configuration option ${m(e)} in ${m("playwright.config.ts")}
  
  \u{1F4D6} ${Qe.guide.integration}`),new fe("Missing required config variable")})}function D(t){return Object.entries(t??{}).reduce((e,[r,n])=>n===void 0?e:{...e,[r]:n},{})}function G(){return!!Ze?.orchestrationId}function w(){return Ze}function _n(t){t.preserveOutput!=="always"&&d(`The "preserveOutput" property in your Playwright config is set to ${t.preserveOutput}. This may cause artifacts to be removed before they are uploaded to Currents. We recommend setting it to "always".`)}function Sn(t){return t?Object.values(t).map(e=>e.name):[]}function et(t,e){return e?.projects===!0?t:Array.isArray(e?.projects)?e?.projects.length===0?t:e?.projects.filter(r=>t.includes(r)):[]}var Zt,Ri,er,Ze,rr=f(()=>{"use strict";i();E();Kt();Jt();R();zt();Xt();Zt=l.extend("config"),Ri=["projectId","recordKey"],er={removeTitleTags:!1,disableTitleTags:!1,orchestration:{skipReporterInjection:!1},coverage:{projects:!1}},Ze=null});function An(t){let e=new WeakMap;function r(n){if(typeof n=="object"&&n!==null){if(e.has(n))return"[Circular]";e.set(n,!0)}}return(0,xn.cloneDeepWith)(t,r)}function tt(t){let r=Object.getOwnPropertySymbols(t).find(s=>s.toString().match(/configInternalSymbol/))??Object.getOwnPropertyNames(t).find(s=>s.match(/_internal/));return r?t[r]:(d("Could not extract internal playwright configuration"),null)}var xn,Pn=f(()=>{"use strict";i();xn=require("lodash");R()});var B=f(()=>{"use strict";i();rr();zt();Xt();Pn()});var bn,wn=f(()=>{bn={name:"@currents/playwright",version:"1.14.1",main:"./dist/index.js",author:{name:"Currents Software Inc",email:"hello@currents.dev",url:"https://currents.dev"},license:"MIT",homepage:"https://currents.dev",repository:{type:"git",url:"https://github.com/currents-dev/currents-playwright-changelog.git"},scripts:{test:"vitest",rm:"rimraf dist",lint:'TIMING=1 eslint "**/*.ts*"',build:"tsup-node --minify --dts",dev:"tsup-node --watch --dts",release:"release-it --verbose","publish:npm":"npm run rm  && npm run build && ./publish.js","release-ci":"npm run rm && npm run build && ./publish.js -t latest"},bin:{pwc:"./dist/bin/pwc.js","pwc-p":"./dist/bin/pwc-p.js"},devDependencies:{"@playwright/test":"^1.44.0","@release-it/conventional-changelog":"^7.0.2","@types/async-retry":"^1.4.5","@types/babel__code-frame":"^7.0.3","@types/debug":"^4.1.12","@types/getos":"^3.0.4","@types/json-stringify-safe":"^5.0.3","@types/lodash":"^4.17.15","@types/pluralize":"^0.0.33","@types/proxy-from-env":"^1.0.4","@types/randomstring":"^1.3.0","@types/regexp.escape":"^2.0.0","@types/shelljs":"^0.8.16","@types/stack-utils":"^2.0.3","@types/tmp":"^0.2.6","@types/ws":"^8.18.1",eslint:"^9.23.0","eslint-config-custom":"*",msw:"^2.8.2","release-it":"^19.0.3",rimraf:"^6.0.1",tsconfig:"*",tsup:"^8.5.0",typescript:"^5.8.3",vitest:"^3.2.3",wtfnode:"^0.10.0"},dependencies:{"@babel/code-frame":"^7.27.1","@commander-js/extra-typings":"^12.1.0","@currents/commit-info":"1.0.1-beta.0","async-retry":"^1.3.3",axios:"^1.9.0","axios-retry":"^4.5.0",c12:"^1.11.2",chalk:"^4.1.2",commander:"^12.1.0","date-fns":"^4.1.0",debug:"^4.3.7",dotenv:"^16.5.0",execa:"^9.5.3",getos:"^3.2.1","https-proxy-agent":"^7.0.5","istanbul-lib-coverage":"^3.2.2","json-stringify-safe":"^5.0.1","lil-http-terminator":"^1.2.3",lodash:"^4.17.21",nanoid:"^3.3.8","object-sizeof":"^2.6.5","p-debounce":"^2.1.0","p-map":"^4.0.0","p-queue":"6.6.2",pino:"^9.6.0",pluralize:"^8.0.0","pretty-ms":"^7.0.1","proxy-from-env":"^1.1.0","regexp.escape":"^2.0.1","source-map-support":"^0.5.21","stack-utils":"^2.0.6",tmp:"^0.2.3","tmp-promise":"^3.0.3","ts-pattern":"^5.7.1",ws:"^8.18.2"},files:["dist","!**/*.map","!**/*/*.map","**/*.LEGAL.txt","LICENSE.md","README.md","CHANGELOG.md"],keywords:["playwright","playwright dashboard","cloud dashboard","reporter","currents","tests reporter","sorry cypress","ci"],exports:{".":{import:"./dist/index.js",require:"./dist/index.js"},"./discovery":{import:"./dist/reporters/discovery.js",require:"./dist/reporters/discovery.js"},"./orchestration":{import:"./dist/orchestration/index.js",require:"./dist/orchestration/index.js"},"./package.json":"./package.json"},publishConfig:{access:"public",registry:"https://registry.npmjs.org"},"release-it":{npm:{publish:!1},github:{release:!0},plugins:{"@release-it/conventional-changelog":{preset:"angular",header:"# Changelog",ignoreVersion:!0,infile:"../../CHANGELOG.md"}},git:{commitMessage:"chore: release v${version}",tagName:"v${version}"},hooks:{"before:github:release":"npm run --prefix ../../ update-public-changelog"}}}});var rt,nr=f(()=>{"use strict";i();wn();rt=bn.version});function st(t={}){let e=vn.default.create(t);return e.interceptors.request.use(r=>{let n={...r},s=e.getUri(r),o=Nn.default.getProxyForUrl(s);return o&&(_i("Using HTTP proxy %s for %s ",o,s),n.proxy=!1,n.httpsAgent=Si(o)),n}),e}function Si(t){return nt||(nt=new On.HttpsProxyAgent(t),nt)}var vn,On,Nn,_i,nt,sr=f(()=>{"use strict";i();vn=g(require("axios")),On=require("https-proxy-agent"),Nn=g(require("proxy-from-env"));E();_i=l.extend("axios");nt=null});var or,Un,Ln=f(()=>{"use strict";i();or=()=>process.env.CURRENTS_API_URL??"https://cy.currents.dev",Un=()=>3e4});function Dn(){ot.addListener("runCancelled",Bn)}function Mn(){ot.removeListener("runCancelled",Bn)}function Bn(){l("Run cancelled: %s",ar()),process.exit(1)}var Fn,ot,ir=f(()=>{"use strict";i();Fn=g(require("events"));E();it();ot=new Fn.default});var ur,at,ar,ut,kn=f(()=>{"use strict";i();R();ir();ur={cancellationReason:null},at=t=>{ur.cancellationReason||(ur.cancellationReason=t)},ar=()=>ur.cancellationReason,ut=({showWarning:t=!0}={})=>{let e=ar();e&&(t&&d("%s",e),ot.emit("runCancelled",e))}});var it=f(()=>{"use strict";i();kn()});var jn,ie,ct=f(()=>{"use strict";i();jn=require("nanoid"),ie=(0,jn.customAlphabet)("abcdefghijklmnopqrstuvwxyz",10)});var lt,cr,_e,pt,gt=f(()=>{"use strict";i();lt=require("ts-pattern"),cr={outcome:null,scannerConfig:null,currentsConfig:null,internalConfig:null},_e=(t,e)=>(0,lt.match)(t).with(lt.P.union("scannerConfig","currentsConfig","internalConfig"),r=>{cr[r]=e}).with("outcome",r=>{cr[r]=e}).exhaustive(),pt=()=>cr});function Vn(t){(0,O.match)(t).when(Gn.isAxiosError,xi).otherwise(()=>{d("Unexpected error while sending network request: %s",t)})}function xi(t){return(0,O.match)(t).with({code:"ECONNABORTED"},()=>{d("Network connection aborted")}).with({code:"ECONNREFUSED"},()=>{d("Network connection aborted")}).with({code:"ECONNRESET"},()=>{d("Network connection reset")}).with({code:"ETIMEDOUT"},()=>{d("Network connection timeout")}).with({response:O.P.not(O.P.nullish)},e=>{Ai(e,{status:e.response.status,data:e.response.data})}).otherwise(e=>{d(`[currents] Unexpected network error: %s
%O`,t.message,{method:t.response?.config.method,url:t.response?.config.url,status:t.response?.status,payload:t.response?.config.data,requestId:je(t)})})}function Ai(t,{status:e,data:r}){(0,O.match)(e).with(401,()=>{d(`[currents] ${t.response?.config.method} ${t.response?.config.url}} - 401 Unauthorized Request from cloud service`)}).with(400,()=>{d(`[currents] ${t.response?.config.method} ${t.response?.config.url} - 400 Bad Request from cloud service:
%o`,r)}).with(429,()=>{d(`[currents] ${t.response?.config.method} ${t.response?.config.url} - 429 Too Many Requests from cloud service`)}).with(422,()=>{Pi(t,r)}).otherwise(()=>{d(`[currents] Unexpected network response: %s
%O`,t.message,{method:t.response?.config.method,url:t.response?.config.url,status:t.response?.status,requestId:je(t)})})}function Pi(t,e){(0,O.match)(e).with({code:lr.MISSING_SUITE,message:O.P.string,errors:O.P.array(O.P.string)},async r=>{let{message:n,errors:s}=r;De(1),_(...$n(n,s)),dt({id:ie(),text:(0,Hn.default)(pt(),null,2)}).then(o=>{_(`Please share this URL with Currents support for further investigation:
${o}`)}).catch(o=>{d("Failed to upload debug artifact: %s",o)}),De(1)}).with({code:lr.RUN_CANCELLED,message:O.P.string},r=>{at(r.message),ut()}).with({code:lr.RUN_EXPIRED,message:O.P.string},r=>{d(r.message)}).with({message:O.P.string,errors:O.P.array(O.P.string)},r=>{let{message:n,errors:s}=r;De(1),d(...$n(n,s)),De(1)}).otherwise(()=>{d(`[currents] Unexpected network response: %s
%O`,t.message,{method:t.response?.config.method,url:t.response?.config.url,status:t.response?.status,requestId:je(t)})})}function $n(t,e){return Wn.default.isString(t)?e?.length===0?[t]:[t,`
${(e??[]).map(r=>`  - ${r}`).join(`
`)}
`]:["Unexpected network error"]}function je(t){return t?.response?.headers["apigw-requestid"]}var Gn,Hn,Wn,O,lr,pr=f(()=>{"use strict";i();Gn=require("axios"),Hn=g(require("json-stringify-safe")),Wn=g(require("lodash")),O=require("ts-pattern");it();ct();R();gr();gt();lr={RUN_CANCELLED:"RUN_CANCELLED",RUN_EXPIRED:"RUN_EXPIRED",MISSING_SUITE:"MISSING_SUITE"}});function Yn(t,e,r){let n=r.method?.toUpperCase(),s=r.url,o=je(e),a=(0,qn.default)(mr(t)),c=`Network request '${n} ${s}' failed: '${e.message}'.${o?` Request ID: ${o}.`:""} Next attempt is in ${a} (${t}/${r["axios-retry"]?.retries||fr()}).`;Kn(c),d(c)}var dr,qn,Kn,mr,Jn,fr,zn=f(()=>{"use strict";i();dr=require("axios"),qn=g(require("pretty-ms"));E();R();pr();Kn=l.extend("http"),mr=t=>[3*1e3,15*1e3,30*1e3][t-1],Jn=t=>(Kn("isRetriableError: %o",{message:t.message,code:"code"in t?t.code:void 0,status:"response"in t?t.response?.status:void 0,headers:"response"in t?t.response?.headers:void 0,data:"response"in t?t.response?.data:void 0,isAxiosError:(0,dr.isAxiosError)(t)}),"code"in t&&t.code&&["ECONNABORTED","ECONNREFUSED","ECONNRESET","ETIMEDOUT","ENETRESET","ENOTFOUND","EAI_AGAIN"].includes(t.code)?!0:(0,dr.isAxiosError)(t)?[429,500,502,503,504].includes(t.response?.status??0):!1),fr=()=>3});function as(t){is["x-pw-version"]=t??"0.0.0"}function Oi(){let t=st({baseURL:or(),timeout:Un(),transitional:{clarifyTimeoutError:!0}});return t.interceptors.request.use(async e=>{let{currentsOptions:r}=e,n={...vi,...r};return n.enableCompression&&(0,ns.default)(e.data)>n.compressThresholdBytes?(e.headers["Content-Encoding"]="gzip",{...e,data:await bi((0,es.default)(e.data))}):e}),t.interceptors.request.use(e=>{let r=e["axios-retry"]?.retryCount??0,n=w();e.headers.set({...is,"Accept-Encoding":"gzip, deflate, br","x-currents-idempotency-key":e.headers["x-currents-idempotency-key"]??(0,rs.nanoid)(),"x-pwc-request-attempt":r,"x-currents-key":n?.recordKey??null}),n?.orchestrationId&&e.headers.set("x-currents-orchestration-id",n.orchestrationId),n?.machineId&&e.headers.set("x-currents-machine-id",n.machineId),e.headers.get("Content-Type")||e.headers.set("Content-Type","application/json");let s={...ts.default.pick(e,"method","url","headers"),data:Buffer.isBuffer(e.data)?"buffer":e.data};return r?Qn("network request retry: %o",Xn({...s,isRetry:!0})):Qn("network request: %o",Xn(s)),e}),(0,Zn.default)(t,{retries:fr(),retryCondition:Jn,retryDelay:mr,shouldResetTimeout:!0,onRetry:Yn}),t}function us(){return mt||(mt=Oi(),mt)}function Xn(t){return{method:t.method,baseUrl:or(),url:t.url,data:t.isRetry?"<retry>":Ni(t.data),headers:{...t.headers,"x-currents-key":"***"}}}function Ni(t){return t?.results?.raw?{...t,results:{...t.results,raw:"***"}}:t}var Zn,es,ts,rs,ns,ss,os,Qn,wi,is,bi,mt,vi,hr=f(()=>{"use strict";i();Zn=g(require("axios-retry")),es=g(require("json-stringify-safe")),ts=g(require("lodash")),rs=require("nanoid"),ns=g(require("object-sizeof")),ss=require("util"),os=g(require("zlib"));B();E();nr();sr();Ln();zn();Qn=l.extend("http"),wi=1024*1024*1,is={"x-pw-version":"0.0.0","x-pwc-version":rt},bi=(0,ss.promisify)(os.default.gzip);mt=null,vi={enableCompression:!1,compressThresholdBytes:wi}});async function L(t,e=us){try{let r=await e().request(t);return cs("network response: %o",{...ls.default.omit(r,"request","config"),url:r.config.url,method:r.config.method}),r}catch(r){let n=r;throw cs("network error: %o",{code:n.code,message:n.message,url:n.config?.url,method:n.config?.method,status:n.response?.status,headers:n.response?.headers,data:n.response?.data}),Vn(n),n}}var ls,cs,ps=f(()=>{"use strict";i();ls=g(require("lodash"));E();hr();pr();cs=l.extend("http")});var ae=f(()=>{"use strict";i();ps()});var gs={};qt(gs,{getDebugUrl:()=>Ui});var Ui,ds=f(()=>{"use strict";i();ae();Ui=({runId:t,type:e})=>L({method:"POST",url:"runs/debug-logs",data:{type:e,runId:t}}).then(r=>r.data)});function Li(t,e){return ft({path:t,name:null,uploadUrl:e,contentType:"text/plain"},"text/plain",void 0)}async function ft(t,e,r){let n=await fs.default.readFile(t.path);return Er("Uploading file %s",t.uploadUrl,{buffer:Buffer.byteLength(n)}),Es(n,t.uploadUrl,e,r)}async function Ir(t,e,r){return Er("Uploading buffer %s",t.name,{buffer:Buffer.byteLength(t.buffer)}),Es(t.buffer,t.uploadUrl,e,r)}async function Fi(t,e,r,n){return st().request({method:"put",url:e,data:t,onUploadProgress:n,headers:{"Content-Disposition":"inline","Content-Type":r}})}async function Es(...t){await(0,ms.default)(async()=>{await Fi(...t)},{retries:5,onRetry:(e,r)=>{if(Er(`Upload failed %d out of 5 attempts: %s 
 %o`,r,e.message,e.response?.data),r===5){_(`Cannot upload after ${r} times: ${e.message}`);return}d(`Upload failed ${r} out of 5 attempts: ${e.message}`)}})}var ms,fs,Er,hs,Is=f(()=>{"use strict";i();ms=g(require("async-retry")),fs=g(require("fs/promises"));E();sr();R();Er=l.extend("upload"),hs=(s=>(s.PNG="image/png",s.WEBM="video/webm",s.TEXT="text/plain",s.ZIP="application/zip",s))(hs||{})});var Cs={};qt(Cs,{ContentType:()=>hs,sendBuffer:()=>Ir,sendPath:()=>ft,uploadText:()=>Li});var Cr=f(()=>{"use strict";i();Is()});async function dt(t){let{getDebugUrl:e}=await Promise.resolve().then(()=>(ds(),gs));try{let{readUrl:r,uploadUrl:n}=await e({runId:t.id,type:"pw-debug"}),{uploadText:s,sendBuffer:o}=await Promise.resolve().then(()=>(Cr(),Cs));return"text"in t&&await o({name:`${t.id}-discovery-debug.log`,buffer:Buffer.from(t.text,"utf-8"),contentType:"text/plain",uploadUrl:n},"text/plain",void 0),"path"in t&&await s(t.path,n),r}catch{return null}}var Tr,Rr=f(()=>{"use strict";i();Tr=g(require("debug"))});function Di(t){return t==="false"?!1:t==="remote"?"remote":t==="full"?"full":!!t}var Ts,Rs,ys=f(()=>{"use strict";i();Ts=require("@commander-js/extra-typings"),Rs=new Ts.Option("--pwc-debug [boolean | 'remote' | 'full']","enable debug logs for the reporter. Specify 'remote' to upload logs to Currents. Specify 'full' to dump the debug logs to stdout and upload to Currents.").argParser(Di).env("CURRENTS_DEBUG")});var _s,Ss,xs=f(()=>{"use strict";i();_s=require("@commander-js/extra-typings");ys();Ss=()=>new _s.Command().allowUnknownOption().addOption(Rs).helpOption(!1)});var Q,As,_r,Ps,ws,yr,ht,Sr=f(()=>{"use strict";i();Q=g(require("debug")),As=g(require("fs")),_r=g(require("path")),Ps=g(require("util")),ws=require("fs/promises");ct();R();xs();Rr();Q.default.useColors=function(){return!1};yr=Q.default.log,ht=class t{constructor(e="core"){this.source=e;this.pipelines={};if(this.mode=Ss().parse().opts().pwcDebug??!1,this.debug=(0,Q.default)(`currents:remote-debug:${this.source}`),!this.mode)return this;if(!this.shouldEnableDebug())return this;let r=process.env.DEBUG?`${process.env.DEBUG},currents*`:"currents*";if(Q.default.enable(r),!this.shouldUploadRemoteDebug())return this;let n=ie(),s=_r.default.resolve(".currents-debug"),o=_r.default.resolve(s,`${n}.log`);(0,ws.mkdir)(s,{recursive:!0}),P(m(`\u{1F47E} Initiated remote ${this.source} debug log collection:`),m(o));let a=As.default.createWriteStream(o,{flags:"a"});return Q.default.log=(...c)=>{this.mode&&(a.write(`${Ps.default.formatWithOptions({colors:!1},...c)}
`),this.shouldMuteLocalStdout()||yr(...c))},this.pipelines[n]={id:n,writeStream:a,type:this.source,tempFilePath:o},this}static factory(e="core"){return this.instance||(this.instance=new t(e)),this.instance}getDebugMode(){return this.mode}async finalize({runId:e}={runId:void 0}){try{let r=Object.keys(this.pipelines);r.length===0&&(this.debug("No debug pipelines found"),Q.default.log=yr);for(let n of r)await this.uploadDebug(n,e??ie())}catch{}finally{Q.default.log=yr}}async uploadDebug(e,r){let n=this.pipelines[e];if(!n){this.debug("No debug pipeline found for id %s",e);return}P(m(`\u{1F47E} ${n.type} debug log written:`),m(n?.tempFilePath));try{let s=await dt({id:r,path:n.tempFilePath});n?.writeStream.end(),P(m(`\u{1F47E} ${n.type} debug log uploaded:`),m(s))}catch(s){d(`Failed to upload ${n.type}} debug log ${m(n.tempFilePath)}: ${s.message}`)}}shouldEnableDebug(){return this.mode==="full"||this.mode==="remote"||this.mode===!0}shouldUploadRemoteDebug(){return this.mode==="full"||this.mode==="remote"}shouldMuteLocalStdout(){return this.mode==="remote"}}});var gr=f(()=>{"use strict";i();Rr();Sr()});var l,E=f(()=>{"use strict";i();gr();l=(0,Tr.default)("currents")});var Ja={};qt(Ja,{configHelpers:()=>qa,currentsReporter:()=>Wa,default:()=>Ka,fixtures:()=>Va});module.exports=Ci(Ja);i();i();i();var $s=g(require("crypto")),At=g(require("fs")),te=g(require("path"));E();i();var Et=g(require("fs")),bs=g(require("istanbul-lib-coverage")),vs=g(require("p-map"));E();var It=l.extend("coverage");function V({target:t,stage:e}){return({event:r,status:n,message:s,details:o})=>{let a=o?JSON.stringify(o):"",c=`[${e}] [${r}] [${n}] ${s} ${a}`,p=["test_attempt_reports_generation","test_attempt_reports_merging"].includes(e)?c:`${c} [${JSON.stringify(t)}]`;It(p)}}async function Ct(t){try{return await Et.default.promises.readdir(t)}catch(e){return It(e),null}}async function Mi(t){try{return await Et.default.promises.readFile(t,"utf-8")}catch(e){return It(e),null}}async function Bi(t){try{let e=JSON.parse(t);return Object.keys(e).length===0?"empty":e}catch(e){return It(e),"invalid"}}async function ki(t,e){try{let n=(await Et.default.promises.stat(t)).size/(1024*1024),s=await Mi(t);if(!s)return e({event:"file_read",status:"failed",message:"Failed to read file",details:{filePath:t,fileSizeInMB:n}}),null;e({event:"file_read",status:"passed",message:"File read successfully",details:{filePath:t,fileSizeInMB:n}});let o=await Bi(s);switch(o){case"empty":return e({event:"parse",status:"passed",message:"Coverage JSON is empty",details:{filePath:t}}),null;case"invalid":return e({event:"parse",status:"failed",message:"Coverage report is not a valid JSON",details:{filePath:t}}),null;default:return e({event:"parse",status:"passed",message:"Coverage report parsed successfully",details:{filePath:t}}),o}}catch(r){return e({event:"file_read",status:"failed",message:"Error processing coverage file",details:{filePath:t,error:r}}),null}}async function Tt(t,e){let r=bs.default.createCoverageMap({}),n=0;if(await(0,vs.default)(t,async s=>{let o=await ki(s,e);if(o)try{r.merge(o),n++,e({event:"merge",status:"passed",message:"Merged file successfully",details:{filePath:s}})}catch(a){e({event:"merge",status:"failed",message:"Failed to merge file",details:{filePath:s,error:a}})}},{concurrency:5}),n===0)return e({event:"merge",status:"failed",message:"No files merged",details:{files:t.length}}),null;e({event:"merge",status:"passed",message:"Merged files successfully",details:{files:n}});try{let s=r.toJSON();return e({event:"parse",status:"passed",message:"Parsed coverage map data",details:{files:t.length}}),s}catch(s){e({event:"parse",status:"failed",message:"Failed to parse coverage map data",details:{files:t.length,error:s}})}return null}var Os=(t,e={})=>e.coverage?.projects===!0?!0:Array.isArray(e.coverage?.projects)&&e.coverage.projects.includes(t);i();i();var xr=require("lodash");i();var Rt=g(require("path"));function Ns(t,e){return ji(Rt.default.relative(e,t.file))}function ji(t){return t.split(Rt.default.sep).join(Rt.default.posix.sep)}function X(t){return Z(t.parent.project())}function A(t){let e=t.titlePath(),r=_t(t).title;return e.slice(e.indexOf(r)+1,e.length)}function yt(t){return t.titlePath().filter(e=>!!e).join(" > ")}function _t(t){let e=t.parent;for(;e.parent?.location;)e=e.parent;return e}function k(t,e){let r=_t(t).location;return Ns(r,e.rootDir)}function M(t){return t.id??t._id}function ue(t,e){return`${M(t)}-${e.retry}`}function Us(t){return{workerIndex:(0,xr.isNil)(t.results[0]?.workerIndex)?-1:t.results[0].workerIndex,parallelIndex:(0,xr.isNil)(t.results[0]?.parallelIndex)?-1:t.results[0].parallelIndex}}function Z(t){if(!t)return"__currents_no_project__";let r=("__projectId"in t?t.__projectId:"").trim(),n=t.name.trim()?r:`project${r?`-0${r}`:""}`;if(n.length>256)throw new Error(`Project name is too long for ${n}`);return n}R();i();var St=g(require("fs")),Ds=g(require("os")),xt=g(require("path"));i();var $e={OR8N_SUITE_FILE_PREFIX:"currents-or8n-",FIXTURES_DIR_PREFIX:"currents-fixtures-",FIXTURES_CONFIG_ERR_FILE:"config_fixture_error.log",FIXTURES_WARNING_FILE_PREFIX:"config_fixture_warning"},ee={ACTION_SKIP:"_currents:rule:skip",ACTION_QUARANTINE:"_currents:rule:quarantine",ACTION_MATCH:"_currents:action:match",ACTION_SKIP_POST:"_currents:rule:skip-post",ACTION_QUARANTINE_POST:"_currents:rule:quarantine-post"};i();var Ge=g(require("fs")),$i=require("tmp-promise");function Ls(t){try{return Ge.closeSync(Ge.openSync(t,"wx")),!0}catch(e){if(e.code==="EEXIST")return!1;throw e}}R();var Fs=()=>process.env.CURRENTS_FIXTURES_TMP_DIR??xt.resolve(Ds.tmpdir(),`${$e.FIXTURES_DIR_PREFIX}${process.ppid}`),Ms=(t,e)=>{let r=e.stack??e.message;St.appendFileSync(t,r)},Ar=t=>(St.mkdirSync(Fs(),{recursive:!0}),xt.join(Fs(),t)),Se=(t,e)=>{let r=Ar(`${$e.FIXTURES_WARNING_FILE_PREFIX}_${t}.log`);Ls(r)&&e.forEach(s=>d(s))};var Gs=l.extend("fixture");function Gi(t){return t.coverage?.dir?te.default.resolve(t.coverage?.dir):te.default.join(process.cwd(),".nyc_output")}function Pr(t){return t.name||"project"}function Hi(t,e){return te.default.join(t,Pr(e))}function Wi(){return $s.default.randomBytes(16).toString("hex")}async function Vi(t,e){let r=await Ct(t);if(!r)return e({event:"find",status:"failed",message:"Coverage directory not found",details:{coverageFiles:r}}),null;if(r.length===0)return e({event:"find",status:"failed",message:"No coverage files found",details:{coverageFiles:r,coverageDir:t}}),null;let n=r.map(s=>te.default.join(t,s));return Tt(n,e)}async function qi(t,e,r){let{project:n,testId:s,retry:o,titlePath:a}=e,c=Pr(n),p=te.default.join(r,`${s}-${o}`),h=V({target:{projectId:c,titlePath:a,testId:s,attemptId:o},stage:"test_attempt_reports_generation"});return await t.addInitScript(()=>window.addEventListener("beforeunload",()=>{if(console.info("Location: "+window.location.href),!window.__coverage__){console.warn("Coverage data is not available in window.__coverage__ before unloading the page.");return}window.collectIstanbulCoverage(JSON.stringify(window.__coverage__))})),await At.default.promises.mkdir(p,{recursive:!0}),h({event:"file_write",status:"passed",message:"Coverage directory created",details:{coverageDir:p}}),await t.exposeFunction("collectIstanbulCoverage",C=>{if(!C)return;let I=te.default.join(p,`${Wi()}.json`);try{At.default.writeFileSync(I,C),h({event:"file_write",status:"passed",message:"Coverage file created",details:{coverageFilePath:I}})}catch(T){h({event:"file_write",status:"failed",message:"Failed to create coverage file",details:{coverageFilePath:I,error:T}})}}),p}async function Ki(t,e,r,n){let{project:s,testId:o,retry:a,titlePath:c}=e,p=Pr(s);for(let T of t.pages())try{await T.evaluate(()=>{if(!window.__coverage__){console.warn("Coverage data is not available in window.__coverage__ after test execution. This may result in incomplete coverage reports.");return}window.collectIstanbulCoverage(JSON.stringify(window.__coverage__))})}catch{d("Failed to collect coverage from all pages. Coverage may be incomplete")}let h=V({target:{projectId:p,titlePath:c,testId:o,attemptId:a},stage:"test_attempt_reports_merging"}),C=await Vi(n,h);if(!C){h({event:"merge",status:"failed",message:"Failed to obtain coverage map",details:{coverageDir:n}});return}let I=te.default.join(r,`${o}-${a}.json`);try{await At.default.promises.writeFile(I,JSON.stringify(C,null,2)),h({event:"file_write",status:"passed",message:"Test attempt coverage file created",details:{coverageOutputPath:I}})}catch(T){h({event:"file_write",status:"failed",message:"Failed to create test attempt coverage file",details:{coverageOutputPath:I,error:T}})}}var Ji=async function({context:t,currentsConfig:e,use:r,testInfo:n}){if(!e)return await Se("coverageFixture",["Currents config not found. Skipping coverage fixture"]),await r(t);if(!Os(Z(n.project),e))return Gs("Coverage is disabled"),await r(t);let{project:s}=n,o,a;try{o=Hi(Gi(e),s),a=await qi(t,n,o)}catch(c){d("Failed to setup coverage context",c)}if(await r(t),!(!o||!a))try{await Ki(t,n,o,a)}catch(c){d("Failed to collect coverage",c)}},Hs=async({context:t,currentsFixturesEnabled:e,currentsConfig:r},n,s)=>{if(!e)return Gs("Currents fixtures disabled, skipping coverage fixture"),await n(t);await Ji({context:t,currentsConfig:r,use:n,testInfo:s})};i();i();i();var wr=class{constructor(){this._state={}}getState(e){return this._state[e]}upsertState(e,r){return this._state[e]||(typeof r=="function"?this._state[e]=r():this._state[e]=r),this._state[e]}async populateState(e,r){return this._state[e]||(this._state[e]=await r),this._state[e]}},H=new wr;E();i();var zs=require("@currents/commit-info"),Qs=require("lodash");i();var wt=require("lodash");E();i();var S=require("lodash");E();ct();var Pt=l.extend("ci"),Yi=(t,...e)=>(0,S.chain)(e).compact().join(t).value(),zi=(t,e)=>(0,S.set)(t,(0,S.camelCase)(e),process.env[e]),y=t=>(0,S.transform)(t,zi,{}),Qi=()=>process.env.TF_BUILD&&process.env.TF_BUILD_BUILDNUMBER,Xi=()=>process.env.TF_BUILD&&process.env.AZURE_HTTP_USER_AGENT,Zi=()=>(0,S.some)(process.env,(t,e)=>/^CODEBUILD_/.test(e)),ea=()=>process.env.bamboo_buildNumber,ta=()=>process.env.CI_NAME&&process.env.CI_NAME==="codeship"&&process.env.CODESHIP,ra=()=>process.env.CI_NAME&&process.env.CI_NAME==="codeship"&&!process.env.CODESHIP,na=()=>(0,S.some)(process.env,(t,e)=>/^CONCOURSE_/.test(e)),sa=()=>process.env.GITLAB_CI||process.env.CI_SERVER_NAME&&/^GitLab/.test(process.env.CI_SERVER_NAME),oa=()=>process.env.GCP_PROJECT||process.env.GCLOUD_PROJECT||process.env.GOOGLE_CLOUD_PROJECT,ia=()=>process.env.JENKINS_URL||process.env.JENKINS_HOME||process.env.JENKINS_VERSION||process.env.HUDSON_URL||process.env.HUDSON_HOME,aa=()=>process.env.WERCKER||process.env.WERCKER_MAIN_PIPELINE_STARTED,ua={appveyor:"APPVEYOR",azure:Xi,awsCodeBuild:Zi,bamboo:ea,bitbucket:"BITBUCKET_BUILD_NUMBER",buildkite:"BUILDKITE",circle:"CIRCLECI",codeshipBasic:ta,codeshipPro:ra,concourse:na,codeFresh:"CF_BUILD_ID",drone:"DRONE",githubActions:"GITHUB_ACTIONS",gitlab:sa,goCD:"GO_JOB_NAME",googleCloud:oa,jenkins:ia,semaphore:"SEMAPHORE",shippable:"SHIPPABLE",teamcity:"TEAMCITY_VERSION",teamfoundation:Qi,travis:"TRAVIS",wercker:aa,netlify:"NETLIFY",layerci:"LAYERCI"};function ca(){let{env:t}=process;return(0,S.findKey)(ua,e=>{if((0,S.isString)(e))return t[e];if((0,S.isFunction)(e))return e()})}var Ws=()=>({appveyor:y(["APPVEYOR_JOB_ID","APPVEYOR_ACCOUNT_NAME","APPVEYOR_PROJECT_SLUG","APPVEYOR_BUILD_NUMBER","APPVEYOR_BUILD_VERSION","APPVEYOR_PULL_REQUEST_NUMBER","APPVEYOR_PULL_REQUEST_HEAD_REPO_BRANCH"]),azure:y(["BUILD_BUILDID","BUILD_BUILDNUMBER","BUILD_CONTAINERID","BUILD_REPOSITORY_URI","SYSTEM_TEAMPROJECT","SYSTEM_COLLECTIONURI"]),awsCodeBuild:y(["CODEBUILD_BUILD_ID","CODEBUILD_BUILD_NUMBER","CODEBUILD_RESOLVED_SOURCE_VERSION","CODEBUILD_SOURCE_REPO_URL","CODEBUILD_SOURCE_VERSION"]),bamboo:y(["bamboo_buildNumber","bamboo_buildResultsUrl","bamboo_planRepository_repositoryUrl","bamboo_buildKey"]),bitbucket:y(["BITBUCKET_REPO_SLUG","BITBUCKET_REPO_OWNER","BITBUCKET_BUILD_NUMBER","BITBUCKET_PARALLEL_STEP","BITBUCKET_STEP_RUN_NUMBER","BITBUCKET_PR_ID","BITBUCKET_PR_DESTINATION_BRANCH","BITBUCKET_PR_DESTINATION_COMMIT"]),buildkite:y(["BUILDKITE_REPO","BUILDKITE_SOURCE","BUILDKITE_JOB_ID","BUILDKITE_BUILD_ID","BUILDKITE_BUILD_URL","BUILDKITE_BUILD_NUMBER","BUILDKITE_PULL_REQUEST","BUILDKITE_PULL_REQUEST_REPO","BUILDKITE_PULL_REQUEST_BASE_BRANCH"]),circle:y(["CIRCLE_JOB","CIRCLE_BUILD_NUM","CIRCLE_BUILD_URL","CIRCLE_PR_NUMBER","CIRCLE_PR_REPONAME","CIRCLE_PR_USERNAME","CIRCLE_COMPARE_URL","CIRCLE_WORKFLOW_ID","CIRCLE_PULL_REQUEST","CIRCLE_REPOSITORY_URL","CI_PULL_REQUEST"]),codeshipBasic:y(["CI_BUILD_ID","CI_REPO_NAME","CI_BUILD_URL","CI_PROJECT_ID","CI_BUILD_NUMBER","CI_PULL_REQUEST"]),codeshipPro:y(["CI_BUILD_ID","CI_REPO_NAME","CI_PROJECT_ID"]),concourse:y(["BUILD_ID","BUILD_NAME","BUILD_JOB_NAME","BUILD_PIPELINE_NAME","BUILD_TEAM_NAME","ATC_EXTERNAL_URL"]),codeFresh:y(["CF_BUILD_ID","CF_BUILD_URL","CF_CURRENT_ATTEMPT","CF_STEP_NAME","CF_PIPELINE_NAME","CF_PIPELINE_TRIGGER_ID","CF_PULL_REQUEST_ID","CF_PULL_REQUEST_IS_FORK","CF_PULL_REQUEST_NUMBER","CF_PULL_REQUEST_TARGET"]),drone:y(["DRONE_JOB_NUMBER","DRONE_BUILD_LINK","DRONE_BUILD_NUMBER","DRONE_PULL_REQUEST"]),githubActions:y(["GITHUB_WORKFLOW","GITHUB_ACTION","GITHUB_EVENT_NAME","GITHUB_RUN_ID","GITHUB_RUN_ATTEMPT","GITHUB_REPOSITORY"]),gitlab:y(["CI_PIPELINE_ID","CI_PIPELINE_URL","CI_BUILD_ID","CI_JOB_ID","CI_JOB_URL","CI_JOB_NAME","GITLAB_HOST","CI_PROJECT_ID","CI_PROJECT_URL","CI_REPOSITORY_URL","CI_ENVIRONMENT_URL","CI_DEFAULT_BRANCH"]),goCD:y(["GO_SERVER_URL","GO_ENVIRONMENT_NAME","GO_PIPELINE_NAME","GO_PIPELINE_COUNTER","GO_PIPELINE_LABEL","GO_STAGE_NAME","GO_STAGE_COUNTER","GO_JOB_NAME","GO_TRIGGER_USER","GO_REVISION","GO_TO_REVISION","GO_FROM_REVISION","GO_MATERIAL_HAS_CHANGED"]),googleCloud:y(["BUILD_ID","PROJECT_ID","REPO_NAME","BRANCH_NAME","TAG_NAME","COMMIT_SHA","SHORT_SHA"]),jenkins:y(["BUILD_ID","BUILD_URL","BUILD_NUMBER","ghprbPullId"]),semaphore:y(["SEMAPHORE_BRANCH_ID","SEMAPHORE_BUILD_NUMBER","SEMAPHORE_CURRENT_JOB","SEMAPHORE_CURRENT_THREAD","SEMAPHORE_EXECUTABLE_UUID","SEMAPHORE_GIT_BRANCH","SEMAPHORE_GIT_DIR","SEMAPHORE_GIT_REF","SEMAPHORE_GIT_REF_TYPE","SEMAPHORE_GIT_REPO_SLUG","SEMAPHORE_GIT_SHA","SEMAPHORE_GIT_URL","SEMAPHORE_JOB_COUNT","SEMAPHORE_JOB_ID","SEMAPHORE_JOB_NAME","SEMAPHORE_JOB_UUID","SEMAPHORE_PIPELINE_ID","SEMAPHORE_PLATFORM","SEMAPHORE_PROJECT_DIR","SEMAPHORE_PROJECT_HASH_ID","SEMAPHORE_PROJECT_ID","SEMAPHORE_PROJECT_NAME","SEMAPHORE_PROJECT_UUID","SEMAPHORE_REPO_SLUG","SEMAPHORE_TRIGGER_SOURCE","SEMAPHORE_WORKFLOW_ID","PULL_REQUEST_NUMBER"]),shippable:y(["SHIPPABLE_BUILD_ID","SHIPPABLE_BUILD_NUMBER","SHIPPABLE_COMMIT_RANGE","SHIPPABLE_CONTAINER_NAME","SHIPPABLE_JOB_ID","SHIPPABLE_JOB_NUMBER","SHIPPABLE_REPO_SLUG","IS_FORK","IS_GIT_TAG","IS_PRERELEASE","IS_RELEASE","REPOSITORY_URL","REPO_FULL_NAME","REPO_NAME","BUILD_URL","BASE_BRANCH","HEAD_BRANCH","IS_PULL_REQUEST","PULL_REQUEST","PULL_REQUEST_BASE_BRANCH","PULL_REQUEST_REPO_FULL_NAME"]),teamcity:null,teamfoundation:y(["BUILD_BUILDID","BUILD_BUILDNUMBER","BUILD_CONTAINERID"]),travis:y(["TRAVIS_JOB_ID","TRAVIS_BUILD_ID","TRAVIS_BUILD_WEB_URL","TRAVIS_REPO_SLUG","TRAVIS_JOB_NUMBER","TRAVIS_EVENT_TYPE","TRAVIS_COMMIT_RANGE","TRAVIS_BUILD_NUMBER","TRAVIS_PULL_REQUEST","TRAVIS_PULL_REQUEST_BRANCH","TRAVIS_PULL_REQUEST_SHA"]),wercker:null,netlify:y(["BUILD_ID","CONTEXT","URL","DEPLOY_URL","DEPLOY_PRIME_URL","DEPLOY_ID"]),layerci:y(["LAYERCI_JOB_ID","LAYERCI_RUNNER_ID","RETRY_INDEX","LAYERCI_PULL_REQUEST","LAYERCI_REPO_NAME","LAYERCI_REPO_OWNER","LAYERCI_BRANCH","GIT_TAG"])}),la=()=>{let{env:t}=process;return{appveyor:{sha:t.APPVEYOR_REPO_COMMIT,branch:t.APPVEYOR_PULL_REQUEST_HEAD_REPO_BRANCH||t.APPVEYOR_REPO_BRANCH,message:Yi(`
`,t.APPVEYOR_REPO_COMMIT_MESSAGE,t.APPVEYOR_REPO_COMMIT_MESSAGE_EXTENDED),authorName:t.APPVEYOR_REPO_COMMIT_AUTHOR,authorEmail:t.APPVEYOR_REPO_COMMIT_AUTHOR_EMAIL},awsCodeBuild:{sha:t.CODEBUILD_RESOLVED_SOURCE_VERSION,remoteOrigin:t.CODEBUILD_SOURCE_REPO_URL},azure:{sha:t.BUILD_SOURCEVERSION,branch:t.BUILD_SOURCEBRANCHNAME,message:t.BUILD_SOURCEVERSIONMESSAGE,authorName:t.BUILD_SOURCEVERSIONAUTHOR,authorEmail:t.BUILD_REQUESTEDFOREMAIL},bamboo:{sha:t.bamboo_planRepository_revision,branch:t.bamboo_planRepository_branch,authorName:t.bamboo_planRepository_username,remoteOrigin:t.bamboo_planRepository_repositoryURL},bitbucket:{sha:t.BITBUCKET_COMMIT,branch:t.BITBUCKET_BRANCH},buildkite:{sha:t.BUILDKITE_COMMIT,branch:t.BUILDKITE_BRANCH,message:t.BUILDKITE_MESSAGE,authorName:t.BUILDKITE_BUILD_CREATOR,authorEmail:t.BUILDKITE_BUILD_CREATOR_EMAIL,remoteOrigin:t.BUILDKITE_REPO,defaultBranch:t.BUILDKITE_PIPELINE_DEFAULT_BRANCH},circle:{sha:t.CIRCLE_SHA1,branch:t.CIRCLE_BRANCH,authorName:t.CIRCLE_USERNAME,remoteOrigin:t.CIRCLE_REPOSITORY_URL},codeshipBasic:{sha:t.CI_COMMIT_ID,branch:t.CI_BRANCH,message:t.CI_COMMIT_MESSAGE,authorName:t.CI_COMMITTER_NAME,authorEmail:t.CI_COMMITTER_EMAIL},codeshipPro:{sha:t.CI_COMMIT_ID,branch:t.CI_BRANCH,message:t.CI_COMMIT_MESSAGE,authorName:t.CI_COMMITTER_NAME,authorEmail:t.CI_COMMITTER_EMAIL},codeFresh:{sha:t.CF_REVISION,branch:t.CF_BRANCH,message:t.CF_COMMIT_MESSAGE,authorName:t.CF_COMMIT_AUTHOR},drone:{sha:t.DRONE_COMMIT_SHA,branch:t.DRONE_SOURCE_BRANCH,message:t.DRONE_COMMIT_MESSAGE,authorName:t.DRONE_COMMIT_AUTHOR,authorEmail:t.DRONE_COMMIT_AUTHOR_EMAIL,remoteOrigin:t.DRONE_GIT_HTTP_URL,defaultBranch:t.DRONE_REPO_BRANCH},githubActions:{sha:t.GITHUB_SHA,branch:t.GH_BRANCH||t.GITHUB_REF,defaultBranch:t.GITHUB_BASE_REF,remoteBranch:t.GITHUB_HEAD_REF,runAttempt:t.GITHUB_RUN_ATTEMPT},gitlab:{sha:t.CI_COMMIT_SHA,branch:t.CI_COMMIT_REF_NAME,message:t.CI_COMMIT_MESSAGE,authorName:t.GITLAB_USER_NAME,authorEmail:t.GITLAB_USER_EMAIL,remoteOrigin:t.CI_REPOSITORY_URL,defaultBranch:t.CI_DEFAULT_BRANCH},googleCloud:{sha:t.COMMIT_SHA,branch:t.BRANCH_NAME},jenkins:{sha:t.GIT_COMMIT,branch:t.GIT_BRANCH},semaphore:{sha:t.SEMAPHORE_GIT_SHA,branch:t.SEMAPHORE_GIT_BRANCH,remoteOrigin:t.SEMAPHORE_GIT_REPO_SLUG},shippable:{sha:t.COMMIT,branch:t.BRANCH,message:t.COMMIT_MESSAGE,authorName:t.COMMITTER},snap:null,teamcity:null,teamfoundation:{sha:t.BUILD_SOURCEVERSION,branch:t.BUILD_SOURCEBRANCHNAME,message:t.BUILD_SOURCEVERSIONMESSAGE,authorName:t.BUILD_SOURCEVERSIONAUTHOR},travis:{sha:t.TRAVIS_PULL_REQUEST_SHA||t.TRAVIS_COMMIT,branch:t.TRAVIS_PULL_REQUEST_BRANCH||t.TRAVIS_BRANCH,message:t.TRAVIS_COMMIT_MESSAGE},wercker:null,netlify:{sha:t.COMMIT_REF,branch:t.BRANCH,remoteOrigin:t.REPOSITORY_URL},layerci:{sha:t.GIT_COMMIT,branch:t.LAYERCI_BRANCH,message:t.GIT_COMMIT_TITLE}}},Vs=t=>{let e=qs();return e?(0,S.chain)(t()).get(e).value():{}};function pa(){return(0,S.chain)(Ws()).omitBy(S.isNull).keys().value()}function qs(){let t=ca();return Pt("detected CI provider name: %s",t),t||null}function ga(){return Vs(Ws)}function Ks(){return Vs(la)}function da(t){return t&&pa().includes(t)}function Js(t){let e=ga(),r=qs(),n=ma(t,r);return Pt("detected CI provider: %s",r),Pt("detected CI params: %O",e),Pt("detected CI build ID: %o",n),{params:e,provider:r,ciBuildId:n}}function ma(t,e){return t?{source:"user",value:t}:da(e)?{source:"server",value:null}:{source:"random",value:`auto:${ie()}`}}var br=l.extend("ci-git");function Ys(t){br("git commit existing info: %O",t);let e=Ks();br("commit info from provider environment variables: %O",e);let r=(0,wt.transform)(t,(n,s,o)=>{let a=s||(e?e[o]:null);return n[o]=(0,wt.defaultTo)(a,null)});return br("combined git and environment variables from provider: %O",r),r}var fa=async()=>{let t=await(0,zs.commitInfo)();return Ys({branch:t.branch,remoteOrigin:t.remote,authorEmail:t.email,authorName:t.author,message:t.message,sha:t.sha,ghaEventData:t.ghaEventData})},bt=(0,Qs.memoize)(fa);var vr=l.extend("fixture"),Or=async function(t,e){let r;try{r=await H.upsertState("fixtureGitInfo",async()=>await bt())}catch(n){vr("Failed to retrieve git info",n)}vr("Git info",r),t&&await t(r)},Xs=async({currentsFixturesEnabled:t},e,r)=>{if(!t)return vr("Currents fixtures disabled, skipping git info fixture"),await e();await Or(e,r)};i();E();var Zs=l.extend("fixture"),Nr=async function(t,e,r=null,n=null){let s=await H.getState("projectRules");if(!s){Zs("No actions found, skipping actions processing"),await t(n||{});return}s.applyBefore(e,r),await t(n||s.rules),s.applyAfter(e,r)},eo=async({gitInfo:t,currentsFixturesEnabled:e},r,n)=>{if(!e)return Zs("Currents fixtures disabled, skipping action fixture"),await r({});await Nr(r,n,t)};i();B();E();i();var to=g(require("crypto"));function ce(t){return typeof t=="string"&&(t=Buffer.from(t)),to.default.createHash("md5").update(t).digest("hex")}i();var lo=require("axios");E();R();i();ae();function ro(t){return L({method:"GET",url:`/rules/project/${t}`,"axios-retry":{retries:1}}).then(e=>e.data)}i();var N={EQ:"eq",NEQ:"neq",IN:"in",NOTIN:"notIn",ANY:"any",EMPTY:"empty",INC:"inc",NOTINC:"notInc",INCALL:"incAll",NOTINCALL:"notIncAll"},no=[N.EMPTY,N.NEQ,N.NOTIN,N.NOTINC,N.NOTINCALL],re={SKIP:"skip",QUARANTINE:"quarantine"};i();var co=require("lodash");i();var so=g(require("lodash")),oo=t=>Array.isArray(t)?t.length>0:!!t,vt=(t,e)=>Array.isArray(t)||Array.isArray(e)?so.default.xor([t].flat(),[e].flat()).length===0:t===e,He=(t,e)=>{if(Array.isArray(e)||Array.isArray(t)){let r=[t].flat(),n=[e].flat();for(let s=0,o=0,a=!1;s<n.length;){let c=He(r[o],n[s]);if(c){s++,o=0;continue}if(a=a||!c,o<r.length)o++;else{if(a)return!1;o=0,s<n.length&&s++}}return!0}return typeof e=="string"&&typeof t=="string"?new RegExp(e).test(t):vt(t,e)},Ur=(t,e)=>{if(Array.isArray(e)||Array.isArray(t)){let r=[t].flat(),n=[e].flat();for(let s=0,o=0;s<n.length;){if(He(r[o],n[s]))return!0;o<r.length?o++:(o=0,s<n.length&&s++)}return!1}return vt(t,e)},io=(t,e)=>{let r=new Set([t].flat());return[e].flat().every(n=>r.has(n))},Lr=(t,e)=>{let r=new Set([t].flat());return[e].flat().some(n=>r.has(n))},ao=(t,e)=>Array.isArray(t)?Lr(t,e):new Set([e].flat()).has(t);i();function Fr(t){return typeof t=="string"?uo(t):Array.isArray(t)?t.map(uo):t}function uo(t){return t.startsWith("@")?t:`@${t}`}var We=({input:t,toMatch:e,op:r,allowRegex:n})=>{let s=(()=>{switch(r){case N.ANY:case N.EMPTY:return oo(t);case N.EQ:case N.NEQ:return n?He(t,e):vt(t,e);case N.IN:case N.NOTIN:return n?Ur(t,e):ao(t,e);case N.INC:case N.NOTINC:return n?Ur(t,e):Lr(t,e);case N.INCALL:case N.NOTINCALL:return n?He(t,e):io(t,e);default:return!1}})();return no.includes(r)?!s:s},Ot=class{constructor(e,r=(n,...s)=>{}){this.rules=e;this._debug=r}matchCondition(e,r){switch(e.type){case"title":case"titlePath":case"file":{let n={input:r[e.type],toMatch:e.value,op:e.op,allowRegex:!0},s=We(n);return this._debug("Check condition type %s : %O and got result %s",e.type,n,s),s}case"git_branch":case"git_authorName":case"git_authorEmail":case"git_remoteOrigin":case"git_message":{let n={input:r.gitInfo&&r.gitInfo[e.type.replace("git_","")],toMatch:e.value,op:e.op,allowRegex:!0},s=We(n);return this._debug("Check condition type %s : %O and got result %s",e.type,n,s),s}case"project":case"testId":{let n={input:r[e.type],toMatch:e.value,op:e.op,allowRegex:!1},s=We(n);return this._debug("Check condition type %s %O and got result %s",e.type,n,s),s}case"tag":{let n=r[e.type]!==void 0?Fr(r[e.type]):void 0,s=e.value!==null?Fr(e.value):null,o={input:n,toMatch:s,op:e.op,allowRegex:!1},a=We(o);return this._debug("Check condition type %s %O and got result %s",e.type,o,a),a}case"error_message":{let n=r.errors?.map(c=>c.message),s=e.value,o={input:n,toMatch:s,op:e.op,allowRegex:!0},a=We(o);return this._debug("Check condition type %s %O and got result %s",e.type,o,a),a}default:return!1}}matchRule(e,r){return this._debug("Check for rule match %j with test %O",e,r),e.matcher.op==="AND"?e.matcher.cond.every(n=>this.matchCondition(n,r)):e.matcher.op==="OR"?e.matcher.cond.some(n=>this.matchCondition(n,r)):!1}getMatchedRules(e){return this.rules.filter(r=>this.matchRule(r,e))}getMatchedRulesGroupedByType(e){let r=this.rules.filter(n=>this.matchRule(n,e));return(0,co.groupBy)(r,n=>n.action[0].op)}getMatchedRulesForAction(e,r){return this.getMatchedRules(e).filter(n=>n.action.some(s=>s.op===r))}};i();var xe=l.extend("fixture"),Nt=class extends Ot{constructor(r){super(r,xe);this.rules=r}actionTrace(r,n,s,o){return{rule:{v:s.v,id:s._id,name:s.name,type:r,appliedAt:Date.now()},testInfo:{config:{version:n.config.version},testId:n.testId,status:o}}}testInfoToMatchable(r,n){return{title:r.title,titlePath:r.titlePath,file:r.titlePath[0],project:r.project.name,testId:r.testId,tag:r.tags,gitInfo:n,errors:r.errors?.filter(s=>!!s.message).map(s=>({message:s.message}))}}markMatchedTest(r,n){try{let s=this.getMatchedRulesGroupedByType(n);for(let[o,a]of Object.entries(s)){if(a.length==0)return;xe("Test matched an action. Matchable: %O, ActionType: %s, Actions: %j",n,o,a);let c=this.actionTrace(o,r,a[0]);r.annotations.push({type:ee.ACTION_MATCH,description:JSON.stringify(c)})}}catch(s){d("Failed to mark a test with matching actions",s)}}applyBefore(r,n){let s=this.testInfoToMatchable(r,n);this.markMatchedTest(r,s);let o=[];try{o=this.getMatchedRulesForAction(s,re.SKIP),o.length>0&&xe("Test matched after before. %O Actions : %j",s,o)}catch(a){d("Failed to apply before actions",a)}o.some(a=>{r.annotations.push({type:ee.ACTION_SKIP,description:JSON.stringify(this.actionTrace(re.SKIP,r,a))}),r.skip(!0,`Skipping due to matched Currents.dev skip action: ${a.name}`)})}applyAfter(r,n){let s=[];try{let o=this.testInfoToMatchable(r,n);s=this.getMatchedRulesForAction(o,re.QUARANTINE),s.length>0&&xe("Test matched after rules. %O Actions : %j",o,s)}catch(o){d("Failed to apply after action",o)}s.some(o=>{r.expectedStatus!==r.status&&(xe("Quarantining test, status was: %s",r.status),r.annotations.push({type:ee.ACTION_QUARANTINE,description:JSON.stringify(this.actionTrace(re.QUARANTINE,r,o,r.status))}),r.status="skipped",r.skip(!0,`Quarantining due to matched Currents.dev action: ${o.name}`))})}},po=async t=>{try{let e=await ro(t);return new Nt(e.rules)}catch(e){return xe("Failed to fetch project actions: %o",(0,lo.isAxiosError)(e)?e.toJSON():e),d("Failed to fetch project actions"),new Nt([])}};i();i();B();E();R();i();var go=require("c12");function mo(t){return(0,go.loadConfig)({name:"currents",configFile:t})}i();R();function fo(t=()=>!1){let e=Date.now(),r=Ea();for(;!t();)if(Date.now()-e>r)throw _(`Could not load Currents config after ${r}ms, exiting...`),new Error("Could not load Currents config")}function Ea(t=5e3){let e=Number(process.env.CURRENTS_CONFIG_LOAD_TIMEOUT_MS);return isNaN(e)||e<1?t:e}var ho=l.extend("config-loader"),Ae=class{constructor(e,r=o=>{},n=()=>{process.exit(1)},s={validationFn:tr}){this.reporterOptions=e;this.onSuccess=r;this.onFailure=n;this.options=s;this._configLoaded=!1;this._promise=null}start(){return this._promise=mo(ye().pwcConfigPath).then(async e=>{this.onSuccess(e),yn(this.reporterOptions,e.config,{validationFn:this.options.validationFn})}).catch(e=>{_("Could not load currents configuration: %O",e),this.onFailure()}).finally(()=>{this._configLoaded=!0}),this}waitSync(){return ho("Waiting to load config..."),fo(()=>this._configLoaded),this}load(){return this._promise||(ho("Starting config loader"),this.start()),this._promise}};i();function q(t){return t!=null}i();var Eo=g(require("fs"));E();var Dr=l.extend("fixture:worker-config:run-if-no-marker");async function Io(t){let e=Ar($e.FIXTURES_CONFIG_ERR_FILE);if(Dr("Checking if error marker exists",e),Eo.default.existsSync(e))return Dr("Error file exists, skipping config loader"),!1;try{return await t(),!0}catch(r){return Ms(e,r),Dr("Failed to load config",r),!1}}async function Co(t){let e=[],r=await Io(async()=>{await H.upsertState("fixtureConfigLoader",new Ae(t,()=>{},()=>{},{validationFn:n=>e=Ia(n)})).load()});return{missingKeys:e,loaded:r}}function Ia(t){return["projectId","recordKey"].map(e=>t[e]?null:e).filter(q)}var To=l.extend("fixture:worker-config"),Mr=async function({config:t,use:e,workerInfo:r,chainedFixture:n=null}){try{let{missingKeys:o,loaded:a}=await Co(t);if(!a){Se("fixture:worker-config:not-loaded",["Failed to load Currents config"]),await e(n);return}if(o.length>0){Se(ce(`missing_config_keys_${o.join("-")}`),o.map(c=>`Missing Currents configuration: "${c}". Currents Fixtures may not work as expected.`)),await e(n);return}}catch(o){To("Failed to load config",o),Se(ce("fixture:worker-config:exception"),["Error loading Currents configuration. Currents Fixtures may not work as expected."]),await e(n);return}let s=w();s&&await H.populateState("projectRules",po(s.projectId)),await e(n||s)},Ro=async({currentsConfigOptions:t,currentsFixturesEnabled:e},r,n)=>{if(!e)return To("Currents fixtures are disabled, skipping config fixture"),await r(null);await Mr({config:t,use:r,workerInfo:n})};var yo={currentsFixturesEnabled:[!0,{scope:"worker",option:!0}],currentsConfigOptions:[{},{scope:"worker",option:!0}],gitInfo:[Xs,{scope:"worker",title:"Currents Git Info"}],currentsConfig:[Ro,{scope:"worker",auto:!0,title:"Currents Configuration"}]},_o={currentsActions:[eo,{auto:!0,scope:"test",title:"Currents Actions"}]},So={context:[Hs,{scope:"test",title:"Currents Coverage"}]};i();var Ca=(t,e=null)=>async function({launchOptions:r},n,s){await Promise.all([Or(null,s),Mr({config:t,use:n,workerInfo:s,chainedFixture:e??r})])},Ta=(t=null)=>async function({contextOptions:e},r,n){let s=await H.getState("fixtureGitInfo");await Nr(r,n,s,t??e)},xo=(t={})=>t.currentsFixturesEnabled===!1?t:{...t,launchOptions:Ca(t.currentsConfigOptions||{},t.launchOptions),contextOptions:Ta(t.contextOptions)};i();i();var di=g(require("fs")),Vt=require("ts-pattern");i();var Ut=require("lodash"),vo=g(require("p-queue")),Oo=g(require("path")),le=require("ts-pattern"),Br=require("util");E();R();Cr();i();ae();function Ao(t,e){return L({method:"POST",url:`/artifacts/test-record/${t}`,data:{...e,_t:Date.now()}}).then(r=>r.data)}function Po(t,e){return L({method:"POST",url:`/artifacts/instance/${t}`,data:{...e,_t:Date.now()}}).then(r=>r.data)}var U=l.extend("artifact"),$r=l.extend("upload-queue"),K=new vo.default({concurrency:20}),Ra=0,ya=0;K.on("active",()=>{$r(`Working on item #${++Ra}.  Size: ${K.size}  Pending: ${K.pending}`)});K.on("add",()=>{$r(`Added item #${++ya}.  Size: ${K.size}  Pending: ${K.pending}`)});var kr=class{constructor(e,r,n,s,o,a){this.testLabel=e;this.testId=r;this.attemptId=n;this.groupId=s;this.artifactId=o;this.artifact=a;this.recordId=null;this.instanceId=null;this.runId=null;this.machineId=null;this.uploadPromise=Promise.resolve();this.uploadedAt=null;this.uploadStartedAt=null;this.createdAt=new Date}startUpload(){let e=async()=>{try{if(!this.recordId)throw new Error("recordId must be set before uploading");if(!this.instanceId)throw new Error("instanceId must be set before uploading");if(!this.runId)throw new Error("runId must be set before uploading");if(!this.machineId)throw new Error("machineId must be set before uploading");U("Creating artifact %o",this.getDebugInfo());let r=await Ao(this.recordId,{createdAt:this.createdAt,type:this.artifact.type,name:this.artifact.name,filename:this.artifact.filename,runId:this.runId,groupId:this.groupId,instanceId:this.instanceId,machineId:this.machineId,testId:this.testId,artifactId:this.artifactId,attemptId:this.attemptId,contentType:this.artifact.contentType,metadata:this.artifact.metadata});if(!r?.uploadUrl){d("Could not get upload instructions for test record artifact %s",this.artifact.path??this.artifact.name);return}this.uploadedAt=new Date,await No(this.artifact,r.uploadUrl),U("Upload completed for test record artifact: %o",this.getDebugInfo())}catch(r){U("Error creating artifact: %o",r,this.getDebugInfo()),d("Could not get upload instructions for test record artifact %s",this.artifact.path??this.artifact.name)}};return this.uploadPromise=K.add(e),this}setRecordId(e,r,n,s){if(this.recordId){U("Record id already set for artifact: %o",this.getDebugInfo());return}U("Starting test record artifact upload: %o",this.getDebugInfo()),this.recordId=e,this.instanceId=r,this.runId=n,this.machineId=s,this.startUpload()}getDebugInfo(){return{testLabel:this.testLabel,recordId:this.recordId,attemptId:this.attemptId,attachment:this.artifact.path??this.artifact.name}}},jr=class{constructor(e,r,n,s){this.instanceId=e;this.groupId=r;this.runId=n;this.artifact=s;this.uploadPromise=Promise.resolve()}startUpload(){let e=async()=>{try{U("Creating instance artifact %o",this.getDebugInfo());let r=await Po(this.instanceId,{name:this.artifact.name,runId:this.runId,groupId:this.groupId,type:this.artifact.type,contentType:this.artifact.contentType,metadata:this.artifact.metadata});if(!r?.uploadUrl){d("Could not get upload instructions for instance %s artifact %s",this.instanceId,this.artifact.path??this.artifact.name);return}await No(this.artifact,r.uploadUrl),U("Upload completed for instance artifact: %o",this.getDebugInfo())}catch(r){U("Error creating artifact: %o",r,this.getDebugInfo()),d("Could not get upload instructions for instance artifact %s",this.artifact.path??this.artifact.name)}};return this.uploadPromise=K.add(e),this}getDebugInfo(){return{instanceId:this.instanceId,attachment:this.artifact.path??this.artifact.name}}},b=class{static{this.uploads=new Map}static{this.ids=new Map}static{this.uploadWarnings=new Set}static createOnceForAttempt(e){return e.attachment.forEach((r,n)=>{this._createOnceForAttempt({...e,attachmentIndex:n},r)}),this}static createOnceForInstance(e){return e.artifact.forEach((r,n)=>{let s=this.getArtifactId({testId:`${e.instanceId}-${e.type}`,attemptId:0,attachment:r,attachmentIndex:n});if(this.uploads.has(s)){U("Instance artifact uploader already exists for %o",{instanceId:e.instanceId,attachment:r.path??r.name});return}let o=new jr(e.instanceId,e.groupId,e.runId,r).startUpload();U("Creating instance artifact uploader %o",{instanceId:e.instanceId,attachment:r.path??r.name}),this.uploads.set(s,o)}),this}static setRecordId(e,r,n,s,o){this.ids.has(e)||(U("Triggering pending uploads for test record %s",r),this.ids.set(e,{recordId:r,instanceId:n,runId:s,machineId:o}),this.uploads.forEach(a=>{"testId"in a&&a.testId===e&&a.setRecordId(r,n,s,o)}))}static getAllUploads(){return Array.from(this.uploads.values()).map(e=>e.uploadPromise)}static dumpUploads(){let e=[],r=[];this.uploads.forEach(n=>{n.recordId&&e.push({recordId:n.recordId,testLabel:n.testLabel,testId:n.testId,attemptId:n.attemptId,name:n.artifact.name,uploadedAt:n.uploadedAt,promise:n.uploadPromise}),n.instanceId&&r.push({instanceId:n.instanceId,name:n.artifact.name,promise:n.uploadPromise})}),$r("Queue size:",K.size),console.table((0,Ut.orderBy)(e,"recordId")),console.table(r)}static getArtifactId(e){let r=e.attachmentIndex??e.attachment.path??e.attachment.name,n=ce(Buffer.from(`${e.testId}-${e.attemptId}-${r}`));return U("Artifact id %s for %o",n,{testId:e.testId,attemptId:e.attemptId,attachmentIndex:e.attachmentIndex,path:e.attachment.path,name:e.attachment.name}),n}static _createOnceForAttempt(e,r){let{testLabel:n,testId:s,attemptId:o,groupId:a}=e,c=r.path??r.name,p=this.getArtifactId({testId:s,attemptId:o,attachment:r,attachmentIndex:e.attachmentIndex??0});if(this.uploads.has(p))return U("Artifact uploader already exists for %o",{testLabel:n,key:p,attachmentLabel:c,attemptId:o}),this;let h=new kr(n,s,o,a,p,{...r,name:r.name,type:Aa(r),filename:Pa(r)});U("Creating artifact uploader %o",{key:p,testLabel:n,attachmentLabel:c}),this.uploads.set(p,h);let C=this.ids.get(s);return C&&h.setRecordId(C.recordId,C.instanceId,C.runId,C.machineId),this}};async function No(t,e){try{await(0,le.match)(t).with({path:le.P.string},r=>ft({name:r.name,path:r.path,uploadUrl:e,contentType:t.contentType},t.contentType,wo(r.path))).with({body:le.P.not(le.P.nullish)},r=>Ir({name:r.name,buffer:r.body,uploadUrl:e,contentType:t.contentType},t.contentType,wo(r.name??"buffer"))).otherwise(()=>{let r=(0,Br.format)("Unknown attachment type: %o",t);d(r),b.uploadWarnings.add(r)})}catch(r){let n=(0,Br.format)("Upload failed: %o",_a(r));b.uploadWarnings.add(n),d(n)}}var wo=t=>({total:e,loaded:r})=>{};function bo(t){return t/1e3/1e3}function _a(t){return(0,Ut.pick)(t,"message","code","method","url")}function Sa(t){return t.subarray(0,8).toString("hex").toUpperCase()}function xa(t){return Object.values({jpeg:"FFD8FF",png:"89504E470D0A1A0A",gif87a:"474946383761",gif89a:"474946383961",bmp:"424D",tiffLE:"49492A00",tiffBE:"4D4D002A"}).some(r=>t.startsWith(r))}function Aa(t){return(0,le.match)(t).when(({contentType:e,body:r})=>{if(e.startsWith("image"))return!0;if(r&&e==="application/octet-stream"){let n=Sa(r);return xa(n)}return!1},()=>"screenshot").when(({contentType:e})=>e.startsWith("video"),()=>"video").when(({name:e,path:r,contentType:n})=>n==="application/zip"&&e==="trace"&&!!r,()=>"trace").when(({name:e,path:r,contentType:n})=>n==="application/json"&&e==="coverage"&&!!r,()=>"coverage").otherwise(()=>"attachment")}function Pa(t){return t.path&&Oo.default.basename(t.path)}rr();E();i();var Uo=require("@babel/code-frame"),Lt=g(require("chalk")),Hr=g(require("fs")),Pe=g(require("path")),Lo=g(require("stack-utils")),Fo=g(require("url"));function Gr(t,e){return t.replace(/^(?=.+$)/gm,e)}function wa(t){let e=t.split(`
`),r=e.findIndex(a=>a.startsWith("    at "));r===-1&&(r=e.length);let n=e.slice(0,r).join(`
`),s=e.slice(r),o;for(let a of s){let{frame:c,fileName:p}=Na(a);if(!(!c||!p)&&!ba(p)){o={file:p,column:c.column||0,line:c.line||0};break}}return{message:n,stackLines:s,location:o}}function ba(t){return t.includes(`${Pe.default.sep}node_modules${Pe.default.sep}`)}function va(t,e){return Pe.default.relative(t.rootDir,e)||Pe.default.basename(e)}function Wr(t,e,r,n){let s=e.stack,o=[],a;if(s){let c=wa(s);if(o.push(c.message),a=c.location,a)if(!e.snippet&&(!n||Hr.default.realpathSync(n)!==a.file)&&(o.push(""),o.push(Lt.default.gray("   at ")+`${va(t,a.file)}:${a.line}`)),o.push(""),e.snippet)o.push(e.snippet);else try{let p=Hr.default.readFileSync(a.file,"utf8"),h=(0,Uo.codeFrameColumns)(p,{start:a},{highlightCode:r});o.push(h)}catch{}o.push(""),o.push(c.stackLines.join(`
`))}else e.message?o.push(e.message):e.value&&o.push(e.value);return{location:a,message:o.join(`
`)}}var Oa=new Lo.default;function Na(t){let e=Oa.parseLine(t);if(!e)return{frame:null,fileName:null};let r=null;return e.file&&(r=e.file.startsWith("file://")?Fo.default.fileURLToPath(e.file):Pe.default.resolve(process.cwd(),e.file)),{frame:e,fileName:r}}function Do(t,e,r,n,s){let o=[];r.status==="passed"&&e.expectedStatus==="failed"&&o.push({message:Gr(Lt.default.red("Expected to fail, but passed."),n)}),r.status==="interrupted"&&o.push({message:Gr(Lt.default.red("Test was interrupted."),n)});for(let a of r.errors){let c=Wr(t,a,s,e.location.file);o.push({message:Gr(c.message,n),location:c.location})}return o}hr();Kt();ir();R();Xe();i();var Mo=g(require("fs"));E();R();var rd=l.extend("output");async function Bo(t){let e=" ".repeat(t.options?.ident??2);P(`${e}\u{1F4BE} JSON output file: ${m(t.outputFile)}`);try{Mo.default.writeFileSync(t.outputFile,JSON.stringify(t.summary,null,2))}catch(r){_("Error writing JSON summary",r.message)}}Sr();i();var Y=require("lodash"),tn=g(require("pluralize"));B();E();i();i();B();i();var Ua=new RegExp("([\\u001B\\u009B][[\\]()#;?]*(?:(?:(?:[a-zA-Z\\d]*(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]*)*)?\\u0007)|(?:(?:\\d{1,4}(?:;\\d{0,4})*)?[\\dA-PR-TZcf-ntqry=><~])))","g");function ko(t){return t.replace(Ua,"")}i();E();i();E();i();i();E();ae();var Ft=class{static create(e){return l("Creating instance: %o",e),L({method:"POST",url:`runs/${e.runId}/pw/instances/v1`,data:e}).then(r=>r.data)}};i();E();Xe();var Vr=l.extend("instance"),qr=class{constructor(e,r,n){this.projectId=e;this.specName=r;this.tests=n;this.claimedCount=0;this.instanceId=null;this.creationRequest=null}async startCreationOnce({run:e,startTime:r,worker:n}){return this.creationRequest?this.creationRequest:(this.creationRequest=e.then(s=>s?Ft.create({runId:s.runId,groupId:s.groupId,machineId:s.machineId,spec:this.specName,worker:n,startTime:r}).then(({instanceId:o,claimedCount:a})=>(Vr("Create instance response: %o",{worker:n,projectId:this.projectId,specName:this.specName,instanceId:o,claimedCount:a}),this.instanceId=o,this.claimedCount=a,{instanceId:o,claimedCount:a})).catch(o=>(se.push("Failed to create instance for project %s, spec file %s: %s",this.projectId,this.specName,o),null)):(Vr("Missing run to create instance [%s] > %s",this.projectId,this.specName),null)),this.creationRequest)}},Ve=class t{static{this.instanceCreations=new Map}static get(e,r){return t.instanceCreations.get(t.getKey(e,r))}static createOnce(e,r,n){let s=t.getKey(e,r),o=t.instanceCreations.get(s);if(o)return Vr("Instance creation already started: %s %s",e,r),o;let a=new qr(e,r,n);return t.instanceCreations.set(s,a),a}static getKey(e,r){return`${e}::${r}`}};R();R();i();var J=require("lodash"),Jr=g(require("path")),Dt=g(require("pluralize")),Mt=g(require("pretty-ms")),Yr=require("process"),Ke=require("ts-pattern");B();nr();Jt();R();i();var jo=require("lodash"),$o=require("ts-pattern");function La(t){if(!t.results?.length)return"skipped";let e=t.results.map(r=>r.status);return e.every(r=>r===e[0])?(0,$o.match)(e[0]).with("skipped",()=>"skipped").with("passed",()=>t.expectedStatus==="passed"?"passed":"failed").with("failed",()=>t.expectedStatus==="failed"?"passed":"failed").otherwise(()=>"failed"):t.results.some(r=>r.status==="passed")&&t.expectedStatus==="passed"||t.results.some(r=>r.status==="failed")&&t.expectedStatus==="failed"?"passed":t.results.some(r=>r.status==="skipped")&&t.expectedStatus==="skipped"?"skipped":"failed"}function Kr(t){switch(t){case"timedOut":return"failed";case"interrupted":return"failed";case"skipped":return"pending";default:return t}}var pe=(0,jo.flowRight)(Kr,La);var ge=class t{constructor(e,r,n,s=w(),o){this.pwConfig=e;this.suite=r;this.executionState=n;this.currentsConfig=s;this.ciBuildId=o;this.loggerChain=Promise.resolve(null);this.runUrl=null;this.runId=null;this.flakySymbol="flaky"}static{this.globalOutput=new Map}static mergeOutputMaps(...e){let r=new Map;e.forEach(s=>{s.forEach((o,a)=>{r.set(a,o)})});let n=[];return Array.from(r.keys()).sort().forEach(s=>n.push(...r.get(s))),n}getIntro(){return[`\u{1F4E6} Currents reporter: ${m([`${z(rt)}`,`recording to project ${this.currentsConfig?.projectId}`].join(" "))}`,`\u{1F3AD} Playwright: ${m([`${z(this.pwConfig.version)}`,`${this.suite.allTests().length} ${(0,Dt.default)("test",this.suite.allTests().length)} in ${this.suite.suites.length} ${(0,Dt.default)("project",this.suite.suites.length)} [${this.suite.suites.map(e=>Z(e.project())).join(", ")}]`,this.pwConfig.shard?["shard",`${this.pwConfig.shard.current}/${this.pwConfig.shard.total}`].join(" "):null].filter(e=>e).join(" "))} `,this.ciBuildId.value?"\u{1F528} CI Build ID: "+[`${z.dim(this.ciBuildId.value)}`,this.ciBuildId.source==="random"?[m("was auto-generated,"),m("learn more at"),pn(Qe.guide.ciBuildId)].join(" "):null].filter(Boolean).join(" "):null].filter(e=>e).join(`
`)}onTestBegin(e){let r=this.executionState.getTestExecution(e),n=`${this.now()} ${z(`starting test attempt #${e.results.length}`)}: ${this.getTestCaseLabel(e)}`;r?.appendOutput([n]),this.logAfterRunCreated(n)}async onTestEnd(e,r){let n=Yr.hrtime.bigint(),s=this.executionState.getTestExecution(e);return this.getTestEndLines(e,r).then(o=>{s?.appendOutput(o,n),this.logAfterRunCreated(o.join(`
`))})}async getTestEndLines(e,r){let n=`finished test attempt #${r.retry+1}`,s=this.executionState.getTestExecution(e),o=await this.executionState.getDashboardUrl(),a=o?await s?.getTestLink(o):null;return[`${this.now()} ${z(`${n}`)}: ${this.getTestCaseLabel(e)}`,[a?["  Recording URL:",m(a)].join(" "):null,["  Expected result:",m(e.expectedStatus)].join(" "),e.results.map((p,h)=>[`    - attempt ${h+1}/${e.retries+1}:`,m(p.status),m(`${(0,Mt.default)(p.duration)}`)].join(" ")).join(`
`)].filter(Boolean).join(`
`),e.results.length===0?m("    - No attempts"):null,r.retry>e.retries?m("    \u2139\uFE0F  Note: retries can exceed max attempts when serial mode is enabled"):null,s?.isFinished()?["  Test result:",this.getStatusLabel(s.currentsState),...s?.isFlaky?[ke(this.flakySymbol)]:[]].join(" "):m("    - waiting for additional attempts to determine test result..."),...this.getInlineErrorsBlock(e,r),"",Ce(),""].filter(p=>p!==null)}onStdOut(...e){this.onOutput("stdout",...e)}onStdErr(...e){this.onOutput("stderr",...e)}onOutput(e,r,n,s){let a=[this.getStdIdentifier(e,n,s),(r??"<empty>").toString()].join(`
`);n?this.executionState.getTestExecution(n)?.appendOutput([a]):t.globalOutput.set(Yr.hrtime.bigint(),[a]),this.logAfterRunCreated(a)}getStdIdentifier(e,r,n){let s=[this.now(),z(`${e} from:`)];return r?s.push(this.getTestCaseLabel(r)):s.push("global output - no tests associated"),n&&s.push(`- attempt #${n.retry+1}`),s.join(" ")}getInlineErrorsBlock(e,r){if(this.executionState.getTestExecution(e)?.isFlaky||pe(e)==="failed"){let s=e.results.filter(o=>o.error);if(s.length)return s.flatMap(o=>["",`  ${cn(`attempt ${o.retry+1} error`)}`,...this.getTestResultError(e,o),`  ${ln(`attempt ${o.retry+1} error`)}`,""])}return[]}async onEnd(e){await this.printSummary(e,this.executionState.getAllTestExecutions())}farewell(e,r){let n=[];n.push(`  Elapsed time: ${m((0,Mt.default)(Date.now()-e.getTime()))}`,`  Artifacts created: ${m(r)}`),this.runUrl&&!G()&&n.push(`  \u{1F310} Run URL: ${m(this.runUrl)}`),this.logAfterRunCreated(n.join(`
`))}chainRunCreation(){Object.values(this.executionState.projectExecutions).length&&(this.loggerChain=this.loggerChain.then(()=>Promise.allSettled([this.executionState.getRunUrl(),this.executionState.getRunId(),this.executionState.getCiBuildId()])).then(([r,n,s])=>{this.runUrl=r.status==="fulfilled"?r.value:null,this.runId=n.status==="fulfilled"?n.value:null;let o=s.status==="fulfilled"?s.value:null;this.runUrl?(o&&this.ciBuildId.source==="server"&&P("\u{1F528} CI Build ID: %s %s",z.dim(o),m("auto-detected")),P("\u{1F310} Run URL: %s",m(this.runUrl)),Ie()):d("Failed to create run recording")}))}now(){return m(new Date().toISOString())}getStatusLabel(e){let r=this.getColor(e),n=(0,Ke.match)(e).when(s=>s==="passed",()=>"passed").when(s=>s==="failed",()=>"failed").when(s=>s==="skipped",()=>"failed").when(s=>s==="pending",()=>"skipped").otherwise(()=>"unknown");return r(n)}getColor(e){return(0,Ke.match)(e).when(r=>r==="passed",()=>Me).when(r=>r==="failed",()=>Te).when(r=>r==="skipped",()=>Te).when(r=>r==="pending",()=>Be).otherwise(()=>J.identity)}getTestCaseLabel(e,r=!0){let n=_t(e).location.file;return[r?`[${X(e)}]`:null,e.location.file!==n?this.relativeFilePath(this.pwConfig,n):null,this.getTestCaseFile(e),A(e).join(" \u203A ")].filter(s=>s).join(" \u203A ")}getTestCaseFile(e,r=!0){let n=this.relativeTestPath(this.pwConfig,e);return e.location&&r?`${n}:${e.location.line}:${e.location.column}`:n}relativeTestPath(e,r){return this.relativeFilePath(e,r.location.file)}relativeFilePath(e,r){return Jr.default.relative(e.rootDir,r)||Jr.default.basename(r)}getTestResultError(e,r){return Do(this.pwConfig,e,r,"  ",!0).map(n=>`
`+n.message+`
`)}getBriefAttachments(e){let r=e.results.flatMap(s=>({attempt:s.retry,attachments:s.attachments}));if(!r.flatMap(s=>s.attachments).length)return[];let n=["  Attachments:"];return(0,J.orderBy)(r,"attempt").forEach(({attachments:s,attempt:o})=>{if(n.push(`    - attempt #${o+1}`),!s.length){n.push(m("       - no attachments"));return}let a=(0,J.groupBy)(s,c=>this.getAttachmentType(c));n.push(`       ${s.length} ${(0,Dt.default)("attachment",s.length)}: ${Object.entries(a).map(([c,p])=>`${p.length} ${c}`)}`)}),n}getAttachmentType(e){return(0,Ke.match)(e.contentType).when(r=>r.startsWith("text/"),()=>"text").when(r=>r.startsWith("image/"),()=>"image").when(r=>r.startsWith("video/"),()=>"video").when(r=>r.startsWith("application/")&&e.name?.endsWith(".json"),()=>"json").when(r=>r.startsWith("application/")&&e.name.startsWith("trace"),()=>"trace").otherwise(()=>"unknown")}getAttachmentDetails(e){return(0,Ke.match)(e.contentType).when(r=>r.startsWith("text/"),()=>`Text ${e.contentType}:
${this.getAttachmentText(e)}`).when(r=>r.startsWith("image/"),()=>`Image (${e.contentType}): ${e.name??""} ${m(e.path??"<Buffer>")}`).when(r=>r.startsWith("video/"),()=>`Video (${e.contentType}): ${e.name??""} ${m(e.path??"<Buffer>")}`).when(r=>r.startsWith("application/")&&e.name?.endsWith(".json"),()=>`JSON file (${e.contentType}): ${e.name??""} ${m(e.path??"<Buffer>")}`).when(r=>r.startsWith("application/")&&e.name.startsWith("trace"),()=>`Trace: ${m(e.path??"<Buffer>")}`).otherwise(()=>`Attachment (${e.contentType}): ${e.name??""} ${e.path??"<Buffer>"}`)}getAttachmentText(e){if(!e.body)return;let r=e.body.toString();return r.length>300&&(r=r.slice(0,300)+"... <truncated>"),r}logAfterRunCreated(...e){this.loggerChain.then(()=>{P(...e)})}async getSummary(e,r={showLinks:!0}){let s=e.filter(v=>v.isFlaky).length,o=e.filter(v=>v.currentsState==="failed"),a=e.filter(v=>v.currentsState==="pending"),c=e.filter(v=>v.currentsState==="passed"),p=c.filter(v=>v.isFlaky),h=o.filter(v=>v.isFlaky),C=a.filter(v=>v.isFlaky),I=e.filter(v=>v.testCase.results.length===0),T=[];I.length>0&&T.push("",oe(`${ne(4)}${I.length} did not run:`),...I.map(v=>`${ne(4)}${this.getTestCaseLabel(v.testCase)}`));let W=[];this.pwConfig.maxFailures&&o.length<this.pwConfig.maxFailures&&W.push(oe(`${ne(4)}Testing stopped early after ${this.pwConfig.maxFailures} maximum allowed failures`));let Oe=[];o.length>0&&Oe.push([`${ne(4)}${Te(`${o.length} failed`)}`,h.length>0?`${oe(`(${h.length} flaky)`)}`:null].filter(Boolean).join(" "),...o.length>0?await this.testTree(o,Te,{flatten:!0,showLinks:r.showLinks}):[]);let Ne=[];c.length>0&&Ne.push([p.length>0?`${ne(4)}${Me(`${c.length} passed`)} ${oe(`(${p.length} flaky)`)}`:null].filter(Boolean).join(" "),...p.length>0?await this.testTree(p,Me,{flatten:!0,showLinks:r.showLinks}):[]);let Ue=[];return C.length>0&&Ue.push([`${ne(4)}${Be(`${a.length} skipped`)} ${oe(`(${C.length} flaky)`)}`].join(" "),...C.length>0?await this.testTree(C,Be,{flatten:!0,showLinks:r.showLinks}):[]),[[`${ne(2)}Test results:`,[qe(e.length,`${`${e.length} overall`}`),qe(c.length,`${Me(`${c.length} passed`)}`),qe(a.length,`${Be(`${a.length} skipped`)}`),qe(o.length,`${Te(`${o.length} failed`)}`),qe(s,`${oe(`${s} flaky`)}`)].join(", ")].join(" "),...Oe,...Ne,...Ue,...T,...W].filter(Boolean).join(`
`)}async printSummary(e,r){this.logAfterRunCreated(await this.getSummary(r))}async testTree(e,r=J.identity,n={flatten:!1,showLinks:!0}){let s=(0,J.groupBy)(e,a=>a.projectId),o=[];return await Promise.allSettled(Object.entries(s).map(async([a,c])=>{let p=[],h=(0,J.groupBy)(c,I=>k(I.testCase,this.pwConfig)),C=!1;await Promise.allSettled(Object.entries(h).map(async([I,T])=>{if(!T.length)return;let W=await this.executionState.getDashboardUrl();if(!W)return;let Oe=await T[0].getInstanceLink(W);!C&&!n.flatten&&(p.push(r(`  [${a}]`)),C=!0);let Ne=!1;await Promise.allSettled(T.map(async Ue=>{let sn=await Ue.getTestLink(W);!Ne&&!n.flatten&&(p.push([r(`    ${I}`),Oe&&n.showLinks?`${m(Oe)}`:""].join(" ")),Ne=!0),p.push(this.testExecutionSummaryLine(Ue,sn,r,{ident:n.flatten?6:8,showProject:n.flatten,showLinks:n.showLinks}))}))})),o.push(...p)})),o}testExecutionSummaryLine(e,r,n=P,s={ident:2,showProject:!0,showLinks:!0}){let o=e.isFlaky?ke.dim(this.flakySymbol):null;return[ne(s.ident),[o,n(this.getTestCaseLabel(e.testCase,s.showProject)),...r&&s.showLinks?[m(r)]:[],m((0,Mt.default)(e.duration))].filter(a=>a!==null).join(" ")].join("")}};function ne(t=0){return" ".repeat(t)}function qe(t,e){return t>0?e:m(e)}i();i();B();R();i();var Bt=g(require("path"));async function Go({config:t,groupId:e,testId:r,titlePath:n}){let s=e.length>0?e:"project",o=Bt.default.resolve(t.dir??".nyc_output",s),a=V({target:{titlePath:n,projectId:e,testId:r},stage:"spec_reports_finding"}),c=await Ct(o);if(!c)return a({event:"find",status:"failed",message:"Coverage directory not found",details:{dir:o}}),null;if(c.length===0)return a({event:"find",status:"failed",message:"No coverage files found",details:{dir:o,files:c}}),[];let p=c.filter(C=>C.startsWith(r)&&Bt.default.extname(C)===".json"),h=p.map(C=>Bt.default.join(o,C));return h.length===0?(a({event:"find",status:"failed",message:"No coverage files found. No files match the testId",details:{dir:o,testId:r,filteredFiles:p}}),[]):(a({event:"find",status:"passed",message:"Coverage files found",details:{dir:o,filteredFilePaths:h,files:h.length}}),h)}async function Ho({runId:t,groupId:e,instanceId:r,specName:n,testExecutions:s}){try{let o=w();if(!(o?.coverage?et([e],o.coverage):[]).length)return;let c=V({target:{spec:n,projectId:e},stage:"spec_reports_finding"}),p=await Promise.all(s.map(T=>Go({config:o.coverage,groupId:e,testId:T.testId,titlePath:T.titlePath}))).then(T=>T.flat().filter(W=>W));if(p.length===0){c({event:"find",status:"failed",message:"No coverage paths found for spec",details:{testExecutions:s.map(T=>T.testId),total:s.length,coveragePaths:p}});return}c({event:"find",status:"passed",message:"Coverage paths found for spec",details:{testExecutions:s.map(T=>T.testId),total:s.length,coveragePaths:p,found:p.length}});let h=V({target:{spec:n,projectId:e},stage:"spec_test_merging"}),C=await Tt(p,h),I=V({target:{spec:n,projectId:e},stage:"spec_reporting"});if(!C){I({event:"report",status:"failed",message:"No coverage data found for spec",details:{coveragePaths:p,files:p.length}});return}b.createOnceForInstance({instanceId:r,groupId:e,runId:t,artifact:[{name:"coverage",body:Buffer.from(JSON.stringify(C)),contentType:"application/json",type:"coverage"}],type:"coverage"}),I({event:"report",status:"passed",message:"Coverage artifact created",details:{coveragePaths:p,files:p.length}})}catch(o){_(`Error sending coverage for spec: ${n}, groupId: ${e}`,o);return}}i();var Wo=require("lodash"),Vo=require("process");E();var Fa=l.extend("testExecution"),we=class t{constructor(e,r,n,s){this.specExecution=e;this.projectId=n;this.specName=s;this.output=new Map;this._testCase=r}get duration(){return this._testCase.results.reduce((e,r)=>e+r.duration,0)}get isFlaky(){return this._testCase.outcome()==="flaky"}get testCase(){return this._testCase}get titlePath(){return`${this.testCase.titlePath().filter(Boolean).join(" > ")}`}get currentsState(){return pe(this.testCase)}get testId(){return this.testCase.id}get getOutput(){return this.output}appendOutput(e,r){this.output.set(r??Vo.hrtime.bigint(),e)}isInterruptedWithError(){return!(!this.testCase.results.some(e=>e.status==="interrupted")||!this.testCase.results.some(e=>!!e.error))}isFinished(){let e=this.testCase.results.map(r=>r.status);return Fa("isFinished?: %o",{title:this.titlePath,allStatuses:e,retries:this.testCase.retries}),!!(e.includes(this.testCase.expectedStatus)||e.length===this.testCase.retries+1)}setTestCase(e){return this._testCase=e,this}getFakeTestCase(){let e=(0,Wo.extend)(this.testCase),r=this.testCase.retries+1-e.results.length;return Array.from({length:r}).forEach(()=>{e.results.push(t.getFakeTestResult(e.results.length+1))}),e}async getInstanceLink(e){let r=(await this.specExecution.instance?.creationRequest)?.instanceId;return r?`${e}/i/${r}`:null}async getTestLink(e){let r=(await this.specExecution.instance?.creationRequest)?.instanceId;return r?`${e}/i/${r}/test/${this.testId}`:null}static getFakeTestResult(e){return{__currents_isFake:!0,status:"skipped",workerIndex:-1,parallelIndex:0,duration:0,startTime:new Date,stdout:["Playwright did not run this test attempt because of maximum allowed failures, or SIGINT"],stderr:["Playwright did not run this test attempt because of maximum allowed failures, or SIGINT"],attachments:[],steps:[],error:{message:"Playwright did not run this test attempt because of maximum allowed failures, or SIGINT",stack:""},errors:[],retry:e}}};var qo=l.extend("specExecution"),kt=class{constructor(e,r,n,s,o){this.projectExecution=e;this.specName=r;this.projectId=n;this.tests=s;this.printer=o;this.testExecutions=new Map;this.instance=null;this.instanceFinishedTask=null}createTestExecution(e,r,n){this.testExecutions.set(e,new we(this,r,this.projectId,this.specName))}getTestExecution(e){return this.testExecutions.get(e)}getAllTestExecutions(){return Array.from(this.testExecutions.values())}isFinished(){return this.getAllTestExecutions().every(e=>e.isFinished())}isFailed(){return this.getAllTestExecutions().map(e=>e.currentsState).some(e=>e==="failed")}hasFlakyTests(){return this.getAllTestExecutions().some(e=>e.isFlaky)}getInstanceCreation(){return Ve.get(this.projectId,this.specName)?.creationRequest}startInstanceCreation(e){return this.instance=Ve.createOnce(this.projectId,this.specName,this.tests),this.instance.startCreationOnce(e)}finish(e){this.isFinished()&&(this.instanceFinishedTask=this._startInstanceFinishedTask(e))}async _startInstanceFinishedTask(e){let r=await this.projectExecution.run;if(!r)return;qo("Starting instance finished task: %o",{ciBuildId:r.ciBuildId,projectId:this.projectId,specName:this.specName});let n=await this.getInstanceCreation();if(!n?.instanceId){d("[currents] Missing reporting instructions for spec file, skipping: [%s] \u203A %s",this.projectId,this.specName);return}if(n?.claimedCount>1){qo('[currents] Results already reported for CI build "%s" [%s] \u203A %s',r.ciBuildId,this.projectId,this.specName);return}await this.sendStdOut({instanceId:n.instanceId,groupId:this.projectId,runId:r.runId}),await Ho({runId:r.runId,groupId:this.projectId,instanceId:n.instanceId,specName:this.specName,testExecutions:this.getAllTestExecutions()})}async sendStdOut({instanceId:e,groupId:r,runId:n}){let s=this.getAllTestExecutions(),o=s.map(h=>h.getOutput),a=ge.globalOutput,c=ge.mergeOutputMaps(a,...o),p=[this.printer.getIntro(),Ce(),c.join(`
`),await this.printer.getSummary(s,{showLinks:!1}),Ce()].join(`
`);b.createOnceForInstance({instanceId:e,groupId:r,runId:n,artifact:[{name:"stdout",body:Buffer.from([p].join(`
`)),contentType:"text/plain",type:"stdout"}],type:"stdout"})}};var um=l.extend("projectExecution"),jt=class{constructor(e){this.projectId=e;this.specExecutions={};this.run=Promise.resolve(null)}setRun(e){return this.run=e,this}upsertSpecExecution(e,r,n,s){return this.specExecutions[e]||(this.specExecutions[e]=new kt(this,e,r,n,s)),this.specExecutions[e]}getSpecExecution(e){return this.specExecutions[e]}getAllSpecExecutions(){return Object.values(this.specExecutions)}};gt();var $t=class{constructor(e){this.config=e;this.projectExecutions={}}upsertProjectExecution(e){return this.projectExecutions[e]||(this.projectExecutions[e]=new jt(e)),this.projectExecutions[e]}getProjectExecution(e){return this.projectExecutions[e]}getAllProjectExecutions(){return Object.values(this.projectExecutions)}getAllSpecExecutions(){return Object.values(this.projectExecutions).flatMap(e=>e.getAllSpecExecutions())}getAllTestExecutions(){return this.getAllSpecExecutions().flatMap(e=>e.getAllTestExecutions())}getProjectExecutionForTestCase(e){return this.getProjectExecution(X(e))}getSpecExecution(e){return this.getProjectExecutionForTestCase(e).getSpecExecution(k(e,this.config))}getTestExecution(e){return this.getSpecExecution(e).getTestExecution(M(e))}getAllPendingPromises(){return[...this.getAllSpecExecutions().map(e=>e.instanceFinishedTask).filter(q)]}getUnfinishedSpecExecutions(){return this.getAllSpecExecutions().filter(e=>!e.isFinished())}async getRun(){let e=this.getAllProjectExecutions();if(e.length)return await e[0].run}async getRunUrl(){return(await this.getRun())?.runUrl}async getRunId(){return(await this.getRun())?.runId}async getDashboardUrl(){return(await this.getRun())?.dashboardUrl}async getCiBuildId(){return(await this.getRun())?.ciBuildId}getExecutionOutcome(){let e=this.getAllSpecExecutions();return this.getAllSpecExecutions().some(n=>n.isFailed())||tt(this.config)?.failOnFlakyTests&&e.some(n=>n.hasFlakyTests())?"failed":"passed"}async getSummary(){let e=this.getAllTestExecutions(),r=await this.getDashboardUrl(),n={};if(process.env.CURRENTS_DISCOVERY_SUMMARY){let s=pt().outcome;n.discovery=s&&"result"in s?s.result:null}return{runId:await this.getRunId()??null,url:await this.getRunUrl()??null,ciBuildId:await this.getCiBuildId()??null,results:{tests:{overall:e.length,flaky:e.filter(s=>s.isFlaky).length,failed:e.filter(s=>s.currentsState==="failed").length,skipped:e.filter(s=>s.currentsState==="pending").length,passed:e.filter(s=>s.currentsState==="passed").length}},details:await Promise.all(e.map(async s=>({projectId:X(s.testCase),url:r?await s.getTestLink(r):null,specName:s.specName,title:A(s.testCase),status:s.currentsState,isFlaky:s.isFlaky,durationMs:s.duration,attempts:s.testCase.results.map(o=>({attemptIndex:o.retry,status:o.status,errorMessage:o.error?.message?ko(o.error?.message):null}))}))),...n}}};i();it();R();i();i();var Xo=require("lodash");B();E();i();var Ko=g(require("getos")),Jo=require("lodash"),j=require("os"),Yo=require("util"),Da=async()=>{if((0,j.platform)()==="linux")try{let t=await(0,Yo.promisify)(Ko.default)();return"dist"in t&&"release"in t?[t.dist,t.release].join(" - "):(0,j.release)()}catch{return(0,j.release)()}return(0,j.release)()},Ma=async()=>{let t=await Da();return{osName:(0,j.platform)(),osVersion:t,osCpus:[],osMemory:{free:(0,j.freemem)(),total:(0,j.totalmem)()}}},zo=(0,Jo.memoize)(Ma);i();ae();function Qo(t){return L({method:"POST",url:"runs/v1",data:t}).then(e=>e.data).catch(e=>{if(e.response&&e.response.status===422)return null;throw e})}var Ba={tags:[]};async function Zo(t){let e=w();if(!e)return null;let r=await bt(),n=await zo(),{browser:s}=t,a={...{browserName:s.name,browserVersion:s.version},...n},c={...Ba,platform:a,commit:r,...t,projectId:e.projectId,recordKey:e.recordKey,ciBuildId:t.ci.ciBuildId.value,tags:e.tag??[],machineId:process.env.CURRENTS_MACHINE_ID??e.machineId,orchestrationId:process.env.CURRENTS_ORCHESTRATION_ID??e.orchestrationId,previousCiBuildId:process.env.CURRENTS_PREVIOUS_CI_BUILD_ID,coverage:et(Sn(t.fullTestSuite),e.coverage)};c.config=An(c.config),l("Creating run: %o",(0,Xo.mapValues)(c,(p,h)=>h==="recordKey"?"******":p));try{let p=await Qo(c);return l("Run created: %o",p),p}catch{return null}}i();B();E();R();gt();i();var ei=g(require("debug")),zr=g(require("fs")),Qr=g(require("tmp")),ti=require("ts-pattern");var Gt=(0,ei.default)("pwc-scanner"),ja=(t,e)=>(0,ti.match)(t).with("project",()=>e.map(r=>`--project=${r}`)).with("grep",()=>`--grep=${e}`).with("grepInvert",()=>`--grep-invert=${e}`).with("configFile",()=>`--config=${e}`).with("repeatEach",()=>`--repeat-each=${e}`).with("cliArgs",()=>null).with("cliOnlyChanged",()=>`--only-changed=${e}`).exhaustive(),ri=async(params,testFilter)=>{let{execa}=await eval('import("execa")'),tmpFile=Qr.default.fileSync({postfix:".json"}),scannerArgs=Object.entries(params).filter(([t,e])=>!!e).map(([t,e])=>ja(t,e)).filter(q).map(t=>Array.isArray(t)?t:[t]).flat();Gt("scannerArgs: %O",scannerArgs);let cliParams=["test","--list",...scannerArgs,"--reporter=@currents/playwright/discovery","--shard=1/1",...params.cliArgs];Gt("running scanner: %O",cliParams);let execaResult=await execa("playwright",cliParams,{reject:!1,env:{PWTEST_WATCH:void 0,CURRENTS_DISCOVERY_PATH:tmpFile.name}}),fileContents=zr.default.readFileSync(tmpFile.name,"utf-8");if(Gt("execa result: %o",execaResult),execaResult.failed){let t=Qr.default.fileSync({prefix:"pwc-scanner-error",postfix:".json"});return zr.default.writeFileSync(t.name,JSON.stringify(execaResult,null,2)),console.error("Error: pwc-scanner failed. Debug: %s",t.name),{execaResult,result:null}}let result=JSON.parse(fileContents);return testFilter&&Array.isArray(result)&&(Gt("filtering tests"),result.forEach(t=>{Array.isArray(t.tests)&&(t.tests=t.tests.filter(e=>testFilter(e.testId)))})),{execaResult,result}};i();var ni=g(require("fs")),si=t=>{try{return JSON.parse(ni.default.readFileSync(t,"utf-8"))}catch(e){console.error("Error reading test suite file",e)}};var Je=l.extend("scanner");async function ii(t){try{let e=w();if(_e("currentsConfig",e),e?.testSuiteFile)return Je("scanner explicit test suite: %o",e.testSuiteFile),si(e.testSuiteFile);let r=tt(t);if(_e("internalConfig",r),Je("internal config: %o",r),!r)return null;let n;(r.lastFailedTestIdMatcher||r.testIdMatcher)&&(n=o=>{let a=!0;return r.testIdMatcher&&(a=r.testIdMatcher(o)),a&&r.lastFailedTestIdMatcher&&(a=r.lastFailedTestIdMatcher(o)),a});let s={cliArgs:r.cliArgs,project:r.cliProjectFilter,configFile:t.configFile,grep:oi(r.cliGrep),grepInvert:oi(r.cliGrepInvert),repeatEach:r.configCLIOverrides.repeatEach,cliOnlyChanged:r.cliOnlyChanged};return Je("scanner config: %o",s),_e("scannerConfig",s),ri(s,n).then(o=>(Je("scanner execa result: %o",o.execaResult),Je("scanner result: %O",o.result),_e("outcome",{execaResult:o.execaResult,result:o.result}),o.result)).catch(o=>(_(o),_e("outcome",{pwcScannerError:o}),null))}catch(e){return _(e),null}}function oi(t){return t?(Array.isArray(t)?t:[t]).join(","):null}i();var ai=g(require("json-stringify-safe")),de=require("lodash"),ui=g(require("p-debounce"));B();E();ae();i();var $a={length:32,separator:"..."},Xr=function(t,e={}){let{length:r,separator:n}={...$a,...e};if(!t)return;if(t.length<=r)return t.trim();let s=n.length,o=r-s,a=Math.ceil(o/2),c=Math.floor(o/2);return t.substring(0,a)+n+t.substring(t.length-c,t.length-1)};R();var be=l.extend("trr"),Zr=class t{constructor(e){this._updateRemoteTestFn=null;this.requestSequence=new en;this.executionChain=Promise.resolve();this.updateRequestSet=new Set;this.recordId=null;this.instanceId=null;this.currentsConfig=null;this.updateCounter=0;this.attemptTriggerEvent=new Map;this.networkRequests=[];this.testCase=e.testCase,this.groupId=e.projectId,this.specName=e.specName,this.currentsConfig=w()}static{this.MAX_STEPS_PER_LEVEL=2e3}get execution(){return this.executionChain}onTestBegin(e){this.testCase=e.testCase,this.setTriggerEventForAttempt(ue(e.testCase,e.testResult??{retry:0}),"testBegin"),this.executionChain=this.executionChain.then(()=>Promise.allSettled([e.runCreation,e.instanceCreation])).then(([r,n])=>r.status==="rejected"||!r.value||n.status==="rejected"||!n.value?null:[r.value,n.value]).then(r=>{if(!r)return null;let[n,s]=r;return this.instanceId=s.instanceId,this.recordId?this.triggerUpdateRemoteTest():this.createRemoteTest(n,e.testCase,e.testResult)})}onStepBegin(e,r){this.testCase=e,this.setTriggerEventForAttempt(ue(e,r),"stepBegin"),this.triggerUpdateRemoteTest()}onStepEnd(e,r){this.testCase=e,this.setTriggerEventForAttempt(ue(e,r),"stepEnd"),this.triggerUpdateRemoteTest(),b.createOnceForAttempt({testLabel:A(e).join(" > "),testId:M(e),attemptId:r.retry,attachment:r.attachments,groupId:this.groupId})}onTestEnd(e,r){this.testCase=e,this.setTriggerEventForAttempt(ue(e,r),"testEnd"),this.triggerUpdateRemoteTest(),b.createOnceForAttempt({testLabel:A(e).join(" > "),testId:M(e),attemptId:r.retry,groupId:this.groupId,attachment:r.attachments})}async createRemoteTest(e,r,n){if(!this.currentsConfig?.recordKey)throw new Error("missing Currents Record Key for createRemoteTest");if(!this.currentsConfig?.projectId)throw new Error("missing Currents Project Id for createRemoteTest");if(this.instanceId)try{be("Creating remote test record for %s",yt(r));let s=await L({method:"POST",url:"/test-record",data:{_v:0,_ct:new Date().toISOString(),_t:this.requestSequence.value,_s:pe(r),_d:this.isTestCaseFinished(),_f:this.isTestCaseFinished()&&this.isTestCaseFlaky(),runId:e.runId,instanceId:this.instanceId,testId:M(r),projectId:this.currentsConfig.projectId,groupId:this.groupId,machineId:e.machineId,spec:this.specName,expectedStatus:r.expectedStatus,annotations:this.resolveAnnotations(this.testCase),timeout:r.timeout,location:{column:r.location.column,file:r.location.file,line:r.location.line},title:A(r),retries:r.retries,attempts:this.getAttemptListPayload(r)},currentsOptions:{enableCompression:!0}});this.recordId=s.data.recordId,be("Remote test record created for %s, recordId: %s",A(r),this.recordId),b.setRecordId(M(r),this.recordId,this.instanceId,e.runId,e.machineId)}catch(s){d(`Cannot create remote test: %s > %s
%s`,this.specName,this.testCase.title,s.message);return}}triggerUpdateRemoteTest(){this.updateCounter++;let e=this.updateCounter;this.executionChain=this.executionChain.then(()=>{if(e!==this.updateCounter){be("Skipping updateRemoteTest: %o",{updateCounter:e,current:this.updateCounter,recordId:this.recordId});return}return this.getUpdateRemoteTestFn()()}).catch(r=>{be("Error while updating remote test: %o",{test:A(this.testCase),error:r.message,record:this.recordId})})}getUpdateRemoteTestFn(){return this._updateRemoteTestFn?this._updateRemoteTestFn:(this._updateRemoteTestFn=(0,ui.default)(this._updateRemoteTest.bind(this),this.getDebounceTime()),this._updateRemoteTestFn)}getDebounceTime(){return G()?1e3:3e3}async _updateRemoteTest(){if(!this.recordId)throw new Error("missing recordId for updateRemoteTest");if(!this.currentsConfig?.recordKey)throw new Error("missing recordKey for updateRemoteTest");if(!this.testCase)throw new Error("missing testCase for updateRemoteTest");let e={_v:0,_e:this.getLastAttemptTriggerEventCode(),_d:this.isTestCaseFinished(),_f:this.isTestCaseFlaky()&&this.isTestCaseFinished(),_s:pe(this.testCase),attempts:this.getAttemptListPayload(this.testCase),annotations:this.resolveAnnotations(this.testCase)},r=this.getPayloadHash(e);if(this.updateRequestSet.has(r)){be("Similar update request was already sent, skipping %s",this.recordId);return}this.updateRequestSet.add(r);try{return L({method:"PUT",url:`/test-record/${this.recordId}`,data:{_t:this.requestSequence.value,...e},currentsOptions:{enableCompression:!0}})}catch(n){be("Error while updating remote test: %o",{test:A(this.testCase),error:n.message,record:this.recordId}),d(`Error while reporting remote test: %s
%s`,A(this.testCase),n.message)}}getPayloadHash(e){return ce(Buffer.from((0,ai.default)(e)))}getTestCaseAnnotations(e){return e.annotations?.map(r=>({type:r.type,description:r.description,source:"test"}))}getAttemptAnnotations(e){return e.annotations?.map(r=>({type:r.type,description:r.description,source:`attempt-${e.retry+1}`}))}resolveAnnotations(e){let r=this.getTestCaseAnnotations(e)??[],n=e.results.flatMap(s=>this.getAttemptAnnotations(s)).filter(q).filter(s=>!r.find(o=>o.type===s.type&&o.description===s.description));return(0,de.uniqBy)([...r,...n].filter(s=>q(s.type)),s=>`${s.type}-${s.description}-${s.source}`)}getAttemptListPayload(e){return e.results.map(r=>({_s:Kr(r.status),_e:this.getTriggerEventCode(this.getAttemptLastTriggerEvent(ue(e,r))),attempt:r.retry,steps:this.getSteps(r.steps),workerIndex:r.workerIndex??-1,parallelIndex:r.parallelIndex??-1,startTime:r.startTime.toISOString(),duration:r.duration,status:r.status,stdout:this.getStdio(r.stdout),stderr:this.getStdio(r.stderr),errors:r.errors.map(n=>this.getError(n)),error:r.error?this.getError(r.error):void 0}))}isTestCaseFinished(){let e=this.testCase.results.map(r=>r.status);return(0,de.last)(e)==="interrupted"||e.includes(this.testCase.expectedStatus)?!0:this.testCase.results.length===this.testCase.retries+1&&this.isLastAttemptFinished()}isLastAttemptFinished(){return this.getLastAttemptTriggerEvent()==="testEnd"}getLastAttemptTriggerEvent(){let e=(0,de.last)(this.testCase.results);return e?this.getAttemptLastTriggerEvent(ue(this.testCase,e)):"testBegin"}getAttemptLastTriggerEvent(e){return this.attemptTriggerEvent.get(e)??"testBegin"}getLastAttemptTriggerEventCode(){return this.getTriggerEventCode(this.getLastAttemptTriggerEvent())}getStdio(e){return e.map(r=>typeof r=="string"?r:r.toString())}getTriggerEventCode(e){switch(e){case"testBegin":return 0;case"stepBegin":return 1;case"stepEnd":return 2;case"testEnd":return 3}}getSteps(e){let r=Object.values((0,de.groupBy)(e,s=>s.category==="hook"?s.title:"default")),n=s=>{let o=[],a=[...s];if(a.splice(0,t.MAX_STEPS_PER_LEVEL).forEach(c=>{o.push({title:c.title,category:c.category,duration:c.duration,steps:n(c.steps),startTime:c.startTime.toISOString(),error:c.error?this.getError(c.error):void 0,location:c.location?this.getLocation(c.location):void 0})}),a.length>0){let c=a.find(p=>p.error);o.push({title:`... ${a.length} more steps`,category:a[0].category,duration:a.reduce((p,h)=>p+(h.duration||0),0),steps:[],startTime:a[0].startTime.toISOString(),error:c?.error?this.getError(c.error):void 0,location:c?.location?this.getLocation(c.location):void 0})}return o};return r.flatMap(n)}getError(e){let n=`
...truncated to fit the 2048-character limit
`;return{message:Xr(e.message,{length:2048,separator:n}),stack:Xr(e.stack,{length:2048,separator:n}),value:e.value,snippet:e.snippet,location:e.location?this.getLocation(e.location):void 0}}getLocation(e){return{column:e.column,file:e.file,line:e.line}}setTriggerEventForAttempt(e,r){this.attemptTriggerEvent.set(e,r)}isTestCaseFlaky(){return this.testCase.outcome()==="flaky"}},me=class t{constructor(){this.container=new Map}static getId(e){return M(e)}create(e,r){let n=t.getId(e);return this.container.has(n)?this.get(n):(this.container.set(n,new Zr({...r,testCase:e})),this.get(n))}get(e){let r=this.container.get(e);if(!r)throw new Error(`TestResultReporter for ${e} not found`);return r}getAllExecutions(){return Array.from(this.container.values()).map(e=>e.execution)}},en=class{constructor(){this.counter=0}get value(){return this.counter++}};var $=l.extend("actor"),Ht=class{constructor(e,r){this.testResultsContainer=new me;this.suite=e,this.config=r,this.executionState=new $t(r);let n=w(),s=Js(n?.ciBuildId);this.printer=new ge(r,e,this.executionState,n,s.ciBuildId),!G()&&P(this.printer.getIntro()),e.suites.forEach(o=>{let a=Z(o.project());$("Creating project execution state for project: %s",a);let c=o.allTests(),p=c.map(I=>({specName:k(I,r),testCase:I})),h=(0,Y.groupBy)(p,"specName"),C=this.executionState.upsertProjectExecution(a).setRun(this.createRun({projectId:a,project:o.project(),createRunParams:{ci:s,browser:{name:a,version:""},tests:c.map(I=>({testId:M(I),spec:k(I,r),title:A(I)})),group:a,config:{pw:this.config,currents:{autoCancelAfterFailures:n?.cancelAfterFailures,removeTitleTags:!!n?.removeTitleTags,disableTitleTags:!!n?.disableTitleTags}}}}));c.forEach(I=>{C.upsertSpecExecution(k(I,r),X(I),h[k(I,r)].map(T=>T.testCase),this.printer).createTestExecution(M(I),I,this.printer)})}),this.printer.chainRunCreation()}async createRun(e){let r=await ii(this.config);return Zo({...e.createRunParams,fullTestSuite:r,projectTags:e.project?.metadata?.pwc?.tags??[]}).then(n=>n?(n?.cancellation&&(at(n.cancellation),ut()),n):(d("Could not start recording for project: %s",e.projectId),null))}onTestBegin(e){$("Test begin: %s",A(e));let r=(0,Y.last)(e.results)??null,n=X(e),s=k(e,this.config),o=this.startCreatingInstance(e);this.testResultsContainer.create(e,{specName:s,projectId:n}).onTestBegin({testCase:e,testResult:r,runCreation:this.executionState.getProjectExecution(n).run,instanceCreation:o}),this.printer.onTestBegin(e)}onTestEnd(e,r){$("Test end: %s, %o",A(e),{attempt:r.retry,status:r.status,duration:r.duration}),this.processPostTestActions(e,r),this.testResultsContainer.get(me.getId(e)).onTestEnd(e,r);let n=this.executionState.getTestExecution(e)?.setTestCase(e);this.printer.onTestEnd(e,r).then(()=>{n?.specExecution.finish(this.config)})}onStepBegin(e,r){this.testResultsContainer.get(me.getId(e)).onStepBegin(e,r)}onStepEnd(e,r){this.testResultsContainer.get(me.getId(e)).onStepEnd(e,r)}async onEnd(e){$("All tests have finished, %o",e),await this.printer.onEnd(e)}async startCreatingInstance(e){let r=this.executionState.getSpecExecution(e),n=(0,Y.first)((0,Y.orderBy)(e.results,"startTime","asc"));return r.startInstanceCreation({run:this.executionState.getProjectExecution(r.projectId).run,startTime:n?.startTime??new Date,worker:Us(e)})}async awaitAllResults(){$("Awaiting for completion of reporting tasks...");let e=[...this.testResultsContainer.getAllExecutions(),...this.executionState.getAllPendingPromises()];await Promise.allSettled(e)}async awaitAllUploads(){$("Awaiting for completion of all uploads..."),await Promise.allSettled(b.getAllUploads())}processSkipActions(e,r,n){if(n.status==="skipped")return;let s=e.filter(o=>o.rule.type===re.SKIP);s.length<1||($("Late Skip Processing: %s, %o",A(r),{originalStatus:n.status,actions:s}),r.annotations.push({type:ee.ACTION_SKIP_POST,description:JSON.stringify(s[0])}),n.status="skipped")}processQuarantineActions(e,r,n){if(n.status==="skipped"||r.expectedStatus===n.status)return;let s=e.filter(a=>a.rule.type===re.QUARANTINE);if(s.length<1)return;$("Late Quarantine Processing: %s, %o",A(r),{originalStatus:n.status,actions:s});let o=s[0];o.testInfo.status=n.status,r.annotations.push({type:ee.ACTION_QUARANTINE_POST,description:JSON.stringify(o)}),n.status="skipped"}processPostTestActions(e,r){let s=(r.annotations||e.annotations).filter(o=>o.type===ee.ACTION_MATCH&&!!o.description).reduce((o,a)=>{try{o.push(JSON.parse(a.description))}catch(c){$("Failed to parse marker description: %O",c)}return o},[]);s.length<1||(this.processSkipActions(s,e,r),this.processQuarantineActions(s,e,r))}reportUnfinishedSpecExecutions(){this.executionState.getUnfinishedSpecExecutions().forEach(e=>{$("Spec execution with no results: %s",e.specName);let r=e.getAllTestExecutions().filter(s=>!s.isFinished()).map(s=>s.getFakeTestCase());if(!r.length)return;$("Non-finished tests: %o",r.map(s=>s.titlePath()));let n=`Playwright did not finish running ${(0,tn.default)("test",r.length,!0)}, reporting missing attempts as ${ke("skipped")}:
`;r.forEach(s=>{let o=s.results.filter(a=>a.__currents_isFake).length;n+=m(`- ${yt(s)} (${o} ${(0,tn.default)("attempt",o)})
`),this.onTestBegin(s),this.onTestEnd(s,(0,Y.last)(s.results)??we.getFakeTestResult(0))}),Ee(n)})}};i();E();i();var ci=g(require("ws"));E();var Wt=l.extend("ws"),ve=null;async function rn(t){await Ga(),ve&&(Wt("sending message to ws: %o, %o",ve.url,t),ve.send(JSON.stringify(t)))}async function Ga(){if(ve){Wt("ws already initialized");return}let t=parseInt(process.env.CURRENTS_PWCP_WSS_PORT);Wt("setting port to %s",t),await new Promise(e=>{ve=new ci.default(`ws://localhost:${t}`),ve.on("open",()=>{Wt("ws opened"),e(null)})})}var Ha=l.extend("or8n-ws");async function li(t){let e=!!process.env.CURRENTS_OR8N_SEND_RESULTS_TO_WSS;if(!e){Ha("Skipping sending JSON summary to WSS: %o",{shouldSendToWSS:e});return}await rn({type:"execution:summary",payload:await t.executionState.getSummary()})}async function pi(){await rn({type:"orchestration:task-finished",payload:{}})}var nn=l.extend("reporter"),gi=l.extend("step"),Ye=class{constructor(e){this.errors=[];this._testActor=null;this.startTime=new Date;this.fullConfig=null;this.remoteDebug=ht.factory("core"),this.configLoader=new Ae(e,this.onC12ConfigLoaded).start();try{this.startTime=new Date}catch(r){(0,Vt.match)(r).with(Vt.P.instanceOf(fe),()=>{process.exit(1)}).otherwise(n=>{throw _("Unexpected error",n),new Error("Unexpected error")})}}printsToStdio(){return!0}onStdOut(e,r,n){this.testActor.printer.onStdOut(e,r,n)}onStdErr(e,r,n){this.testActor.printer.onStdErr(e,r,n)}onBegin(e,r){this.configLoader.waitSync(),this.fullConfig=e,nn("Beginning tests execution: %o",r.allTests().map(n=>n.titlePath())),G()||_n(e),as(e.version),Dn(),this._testActor=new Ht(r,e)}onError(e){_(`Global error reported by test runner:
%s`,Wr(this.fullConfig,e,!0).message),this.errors.push(e)}onStepBegin(e,r,n){gi("> %s %s",n.category,n.title),this.testActor.onStepBegin(e,r)}onStepEnd(e,r,n){gi("< %s %s",n.category,n.title),this.testActor.onStepEnd(e,r)}onTestBegin(e){this.testActor.onTestBegin(e)}onTestEnd(e,r){this.testActor.onTestEnd(e,r)}async onEnd(e){try{await this.testActor.onEnd(e),this.testActor.reportUnfinishedSpecExecutions(),await this.testActor.printer.farewell(this.startTime,b.getAllUploads().length),await this.testActor.awaitAllResults(),G()&&(await li({executionState:this.testActor.executionState}),this.isOr8nEventMode()?(nn("Orchestrated run with event mode enabled: sending execution state and marking task as finished before uploads complete."),await pi()):nn("Orchestrated run in loop mode detected. Sending execution state after execution completes.")),m("  Finalizing uploading artifacts to Currents..."),await this.testActor.awaitAllUploads();let r=await this.testActor.executionState.getRunUrl();if(r&&process.env.CURRENTS_RUN_URL_FILE&&(console.log("Writing run url to file",process.env.CURRENTS_RUN_URL_FILE),di.default.writeFileSync(process.env.CURRENTS_RUN_URL_FILE,r)),!this.testActor.executionState.getAllSpecExecutions().length)return Ie(),d("No tests detected, stopping execution"),Ie(),e;this.errors.length>0&&(Ee(`Execution errors:
`),this.errors.forEach(o=>console.error(o.message))),Le.length>0&&(un(`Execution errors:
`),Le.forEach(o=>P(o))),se.length&&(Ee(`Execution warnings:
`),se.forEach(o=>P(o))),b.uploadWarnings.size>0&&(Ee(`Upload warnings:
`),b.uploadWarnings.forEach(o=>P(o)));let s=await this.testActor.executionState.getRunId();if(process.env._CURRENTS_E2E_TESTS&&await new Promise(o=>setTimeout(o,1e3)),!G()){let o=w()?.outputFile;o&&await Bo({outputFile:o,summary:await this.testActor.executionState.getSummary()}),Ie(),P("\u{1F3C1} Done!")}return await this.remoteDebug.finalize({runId:s}),{status:this.testActor.executionState.getExecutionOutcome()}}catch(r){return console.error(r),{status:"failed"}}finally{Mn()}}onC12ConfigLoaded(e){Object.keys(e.config).length>0&&m("Using config file: %s",e.configFile)}get testActor(){if(!this._testActor)throw new Error("@currents/playwright panic: Test actor not initialized");return this._testActor}isOr8nEventMode(){return process.env.CURRENTS_OR8N_EVENT_MODE==="true"}};var Wa=t=>["@currents/playwright",t],Va={baseFixtures:yo,coverageFixtures:So,actionFixtures:_o},qa={includeCurrentsWrappers:xo},Ka=Ye;0&&(module.exports={configHelpers,currentsReporter,fixtures});
/*! For license information please see index.js.LEGAL.txt */
//# sourceMappingURL=index.js.map